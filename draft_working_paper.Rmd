
---
title: "How do changes in ex vary between countries?"
author: "Jon Minton, Lucinda Hiam"
date: "22/02/2022"
output:
  html_document:
    df_print: paged
    always_allow_html: yes
  word_document: default
---

# To dos

- [ ] Create flextable by decade

# Introduction 

Stalling of life expectancy improvements occurred in the UK from 2010 onwards. It was also seen in some other Western European countries. While the reason and severity of this is debated, some also contend the stalling of improvements seen is artefact following an unusual decade of improvement in 2000s (e.g. Murphy 2021).

- [ ] Introduction to be written once methods/results discussed and decided on

This notebook will compare annual changes in life expectancy at both birth ($e_0$) and at age 65 ($e_{65}$) from 1980 to 2019 (or the latest available year) in England and Wales, Scotland, France, Italy, Spains and Germany. Germany includes a 'Synthetic Germany' created from a weighted average of East and West German data for common years. The method for creating this 'Synthetic Germany' is covered in the methods section in brief and in Appendix X for more detail. In order to explore the hypothesis that the recent stalling in life expectancy, most marked in England and Wales, was an expected 'correction' after a decade of unusually fast life expectancy improvements, we have selected the years from 1980 onwards.


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  tab.id = NULL,
  tab.cap = NULL,
  tab.topcaption = TRUE,
  tab.lp = "tab:"  
  
  )
```

# Methods 

## Data 

Data were extracted from the [Human Mortality Database](https://mortality.org/) via the R package [`HMDHFDplus`](http://www.demogr.mpg.de/en/projects_publications/publications_1904/mpidr_technical_reports/reading_human_fertility_database_and_human_mortality_database_data_into_r_5438.htm). 

The following countries are included in the comparison:

- England & Wales (`GBRTENW`)
- Scotland (`GBR_SCO`)
- UK as a whole (`GBR_UK`) #we haven't included UK but can do
- France (`FRANTP`)
- Spain (`ESP`)
- Italy (`ITA`)
- Germany
   - Total Germany (`DEUTNP`)
   - East Germany (`DEUTE`)
   - West Germany (`DEUTW`)
   - Simulated/Synthetic Germany


```{r, echo=FALSE}
# load packages
pacman::p_load(knitr, here, segmented, tidyverse, kableExtra)



# load data 
hmd_lt <- read_rds(here("data", "lifetables.rds"))

# Labels for codes 
country_code_lookup <- 
  tribble(
    ~code, ~country,
    "DEUTNP", "Germany",
    "DEUTE", "East Germany",
    "DEUTW", "West Germany",
    "ESP", "Spain",
    "FRATNP", "France", 
    "ITA", "Italy",
    "GBRTENW", "England & Wales",
    "GBR_SCO", "Scotland",
    "DEUTSYNTH", "Synthetic Germany"
  )

countries_of_interest <- c(
  "GBRTENW",
  "GBR_SCO",
  "GBR_UK",
  "FRATNP",
  "ESP",
  "ITA",
  "DEUTNP",
  "DEUTE", 
  "DEUTW"
)

source(here("R", "make_synthetic_germany_functions.R"))


```


## Analysis 

For each of these countries, and for males and females separately, we are interested in the annual changes in life expectancy at birth ($e_0$) and life expectancy at age 65 ($e_{65}$), from 1980 to the last available year for each country. In addition, we compare average life expectancy improvements over the 4 decades: 1980, 1990, 2000, and 2010.

We then compared whether the average between the decades was significant, using a regression model. 

### Synthetic Germany 

- To maybe be moved to the appendix later 

To allow UK national trends to be compared with a single German population, we attempted to produce a 'Synthetic German' population with data for East and West Germany for years prior to reunification. We estimated that this 'Synthetic Germany' could be produced by using a weighted average of 20% East Germany, and 80% West German life expectancy trends. More precise estimates can be produced, and the methods used to reach this conclusion are detailed in Appendix X. 



```{r, echo = FALSE}
source(here("R", "make_pop_selection.R"))
```

# Results

## Descriptive Results 

### Life expectancy trends 

The following figures show life expectancy at birth and at age 65 for selected nations from 1980 to the latest available year for males and females.


```{r, echo = FALSE, fig.cap = "Life Expectancy at birth"}
hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at birth",
    title = "Life expectancies at birth for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )
```



```{r, echo = FALSE, fig.cap = "Life Expectancy at age 65"}
hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at age 65",
    title = "Life expectancies at age 65 for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )
```


## Change in life expectancy in these nations 

Next, we compare the annual change in life expectancy at birth and at aged 65 years for the nations from 1980 to the latest available year, by sex.

```{r, echo=FALSE}
change_in_ex_selected_countries <- 
  hmd_ex_selected_countries_with_synth %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    ungroup() 
```

### Changes in life expectancy at birth 


```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 0) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at birth, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )
```

### Changes in life expectancy at age 65 


```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 65) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at age 65, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )
```


## Time trends 

Finally, we used time-trend analysis to explore the changes in life expectancy over the 4 decades: 1980s, 1990s, 2000s, and 2010s. This produces the average change for the decade, whether negative or positive, the standard error and its statistical significance for each country by sex.


```{r, echo = FALSE, warning = FALSE, message = FALSE}
hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    filter(!(code %in% c("DEUTE", "DEUTW", "DEUTNP"))) %>%  # Using only synthetic germany for longer time period
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    nest() %>% 
    mutate(
      rwd_model = map(data, ~lm(delta_ex ~ 1, data = . )),
      ar_model  = map(data, ~lm(delta_ex ~ lag(delta_ex), data = .))
    ) %>% 
    mutate(
      aic_rwd = map_dbl(rwd_model, AIC),
      aic_ar  = map_dbl(ar_model, AIC)
    ) %>% 
    mutate(
      diff_aic = aic_ar - aic_rwd
    )  %>% 
  # filter(diff_aic > 0)
  mutate(
    tidied_ar_model = map(ar_model, broom::tidy)
  ) %>% 
  unnest(tidied_ar_model) %>% 
  filter(term == "(Intercept)") %>% 
  arrange(desc(estimate)) %>%
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  select(code, country, x, sex, estimate, std.error) %>% 
  mutate(display_label = glue::glue("{country}_{x}_{sex}")) %>% 
  ggplot(aes(estimate, fct_reorder(display_label, estimate))) + 
  geom_point(aes(colour = x), show.legend = FALSE) +
  expand_limits( x = 0) + 
  geom_vline(xintercept = 0) + 
  labs(
    x = "Average annual life expectancy change",
    y = "Country-sex combination",
    title = "Average annual improvements by country and sex",
    subtitle = "Range: 1980 to 2020 or nearest available years",
    caption = "Source: Human Mortality Database"
  ) + 
  facet_wrap(~x)
  
```

## Graphs of annual change in life expectancy

The below graphs show the annual change in life expectancy at birth and at aged 65 years for males and females for the nations examined. The pink and green lines are non-linear smoothed.

NB: those with statistically significant 'breakpoints' in annual change in life expectancy are listed in the table above.

```{r}
source(here("R", "annual_change_graphs_by_population.R"))
source(here("R", "breakpoint_functions.R"))
```


## Average improvements by decade

- [ ] Add further introduction 
- [ ] Add statistical significance (though maybe this is a different analysis)

The table below shows average improvements by decade for England and Wales (standard error).

```{r, echo=FALSE, tab.cap = "Source: HMD"}
hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>%
    mutate(decade = year - (year %% 10)) %>% 
    filter(!is.na(delta_ex)) %>% 
  group_by(code, x, sex, decade) %>% 
  summarise(
    mean_delta_ex = mean(delta_ex),
    sd_delta_ex   = sd(delta_ex)
    ) %>% 
  ungroup() %>% 
  mutate(cell_contents = glue::glue("{round(mean_delta_ex, 3)} ({round(sd_delta_ex, 3)})")
  ) %>% 
  filter(code == "GBRTENW") %>% 
  filter(x == 0) %>% 
  select(sex, decade, cell_contents) %>% 
  spread(decade, cell_contents) #%>% 
#  write.csv("clipboard")

```

### Are the differences by decade statistically significant? 

Are there significant differences in average rates of change in $e_x$ by decade? Another way of expressing this question is to ask whether knowing the decade in which an observation has been observed is informative as to what such values will be. This rephrased question was addressed by, for each starting age (0 or 65 years), sex and country, fitting two competing model specifications - $M_0$ and $M_A$ - and running an F test on the residuals of these two models. The Null model specification, $M_0$, regresses $\delta e_x$ (observed annual changes in $e_x$) against a single intercept term $\alpha$; put another way: $M_0$ assumes that all observations are drawn from a Normal distribution with a mean value of $\alpha$, and that this is consistent across all observed decades. The alternative model specification, $M_A$, also includes the $\alpha$ term, but also includes dummy variables to indicate which decade the realised value of $\delta e_0$ corresponds to. (Because one of the decades needs to be the reference category against which other decades are compared, there are one fewer decadal dummy variables than decades in the dataset for a given country, and the $\alpha$ parameter in $M_A$ estimates the mean change in $\delta e_0$ in the first decade, and so cannot be compared directly with the $\alpha$ parameter in $M_0$.) A P-value from the F test comparing $M_0$ and $M_A$ of less than 0.05 is taken to indicate that $M_A$ should be preferred to $M_0$, and so that there are systemic differences in average rates of improvement by decade for a given country, sex, and starting age. 


We found the only significant change decade-on-decades was for East Germany for females at birth and at aged 65 years. This is consistent with existing literature in this area, showing the convergence of life expectancy for females in East and West Germany following reunification.


```{r echo = FALSE}
source(here("R", "make_decadal_change_models.R"))
  
  
```

The following combinations of country, starting age, and sex indicate statistically signifanct improvements in model fit if using a model which allows the annual changes to vary by decade

```{r}
all_null_decadal_models %>% 
  filter(anova_pval < 0.05) %>% 
  arrange(desc(anova_pval)) %>% 
  select(code, x, sex, anova_pval)
```
* East Germany, Females, e0
* East Germany, Males, e65

For these two populations, the decadal model has the following coefficients: 

```{r}
all_null_decadal_models %>% 
  filter(anova_pval < 0.05) %>% 
  arrange(desc(anova_pval)) %>% 
  select(code, x, sex, model_alt) %>% 
  mutate(
    model_results = map(model_alt, broom::tidy)
  ) %>% 
  select(-model_alt) %>% 
  unnest(model_results) %>% 
  mutate(
    term  = case_when(
      term == "(Intercept)" ~ "Baseline (1980s)",
      term == "factor(decade)1990" ~ "1990s",
      term == "factor(decade)2000" ~ "2000s",
      term == "factor(decade)2010" ~ "2010s",
      TRUE ~ NA_character_
    )
  ) %>% 
  mutate(
    label = glue::glue("{round(estimate, 3)}{case_when(p.value < 0.01 ~ '***', p.value < 0.05 ~ '**', p.value < 0.10 ~ '*', TRUE ~ '')} ({round(std.error, 3)})")
  ) %>% 
  ungroup() %>% 
  select(
    x, Term = term, label
  ) %>% 
  pivot_wider(values_from = label, names_from = x) %>% 
  kable(format = "html", table.attr = "style=\"color: black;\"",caption = "Coefficients of decadal differences, East Germany, females, by starting age (0 = life expectancy at birth; 65 = life expectancy at age 65 years") %>% 
  kableExtra::kable_styling() %>% 
  footnote(general = "The baseline is the average annual rate of improvement in the 1980s. The other terms indicate increments or decrements from this baseline. Statistical significance of coefficients: * if p < 0.10, ** if p < 0.05, *** if p < 0.01"
  )
```

The above table indicates that, in females in East Germany, the 1990s was associated with a substantial increase in annual life expectancy increases, at both birth ($e_0$) and age 65 years ($e_{65}$). These increases throughout the 1990s were greater than a fifth of a year per year on average. 

## Changepoint and breakpoint analysis.

Though there may be systemic differences in average changes in life expectancy over time, such differences may not be patterned by decade, and so the above model specification may not have been appropriate to detect any such changes. Instead of looking for systemic differences by decade, we can instead look at whether there are any systemic and detectable 'breaks' in the trends over time. We should also be mindful that, over the period under consideration, there may potentially be no, one, or more distinct breaks in the series. 

To investigate this, we use two approaches to identify both whether and how many breaks may exist in the life expectancy trend data. 

* Approach one: breakpoint analysis on life expectancy against time 
* Approach two: changepoint analysis on life expectancy change rates against time. 

For both approaches, the underlying rationale is the same: 

* We first fit a 'null' (no change) model to the data. These are models that represent the assumption that no change occurred in trends in life expectancy over time. 
* Then we fit a series on one-break models to the data. These are models that represent the assumption that a single significant change occurred to the series over time. From this series of one-break models, we attempt to find the best one-break model. 
* We then fit a series of two-break models to the data. These are models that represent the assumption that were were two significant changes to the series over time. From this series of two-break models, we attempt to find the best two-break models. 
* We now have three models to compare: the null model ($M_0$), the best one-break model ($M_1$), and the best two-break model ($M_2$). Although both $M_1$ can be compared directly^[By 'compared directly', we mean that one model specification can be expressed as a restricted/constrained version of another model, the unrestricted model, with one or more terms in the unrestricted model set to fixed values, usually zero, in the restricted model. Such models can be compared directly using an F-test] with $M_0$, and $M_2$ can be compared directly with $M_0$, $M_2$ cannot necessarily be compared directly with $M_1$. Instead, the triplet of models ($M_0$, $M_1$ and $M_2$) are compared indirectly using BIC^[BIC stands for Bayesian Information Criterion, like the similar AIC (An Information Criterion or Akaike's Information Criterion), is a penalised model fit score. By penalised this means that the fit of the model to the data (more specifically its log likelihood) is calculated, then a 'penalty' is applied to this score based on the complexity of the model. BIC and AIC differ only according to how the penalty is applied, with BIC tending to penalise more complex models more severely than AIC. This means BIC will tend to be more conservative in selecting models, providing some protection against overfitting. Both AIC and BIC can be used to compare both nested and non-nested models based on the same dataset, unlike the F-test, the Lagrange Multiplier Test, and so on. Measures of model fit should *not* be used to compare models fit to different datasets.^[
For example, it would be wrong to conclude that a model with an $R^2$ or adjusted $R^2$ fit to one dataset of 0.80 is 'better' than a model with an $R^2$ or adjusted $R^2$ of 0.50 fit to a different dataset, even though $R^2$ and its variants are often (mis)interpreted in this way
], which like AIC provides a penalised model fit score. Lower BIC scores indicate better fit to the data, and so, for each dataset, the model ($M_0$, $M_1$ or $M_2$) with the lowest BIC will be selected. 
* For the best of the three models for each dataset, the breakpoint or breakpoints (if any), and the model predictions, will be presented and visualised. 



Breaks in the data are calculated through two approaches:

1. For life expectancy against time ($e_x \sim t$), breakpoints are calculated using the $segmented$ function in the $segmented$ package. Both one and two breakpoint models are calculated using this package.
2. For changes in life expectancy against time ($ \frac{de_x}{dt} \sim t$), regressions which allow varying intercepts are calculated. More specifically, the models being compared are: 
    * **$M_0$**: $\frac{de_x}{dt} \sim \alpha$
    * **$M_1$**: $\frac{de_x}{dt} \sim \alpha + \beta T$, where 
    
$$
T = \left\{
    \begin{array}\\
        1 & \mbox{if } \ t \ge \tau \\
        0 & \mbox{otherwise}
    \end{array}
\right.
$$
    * **M_2**: $\frac{de_x}{dt} \sim \alpha + \beta_1 T_1 + \beta_2 T_2$, where 
    
$$
T_1 = \left\{
    \begin{array}\\
        1 & \mbox{if } \tau_1 \le t \lt \tau_2 \\
        0 & \mbox{otherwise}
    \end{array}
\right.
$$
and 

$$
T_2 = \left\{
    \begin{array}\\
        1 & \mbox{if } t \ge \tau_2 \\
        0 & \mbox{otherwise}
    \end{array}
\right.
$$
i.e. the selection of $\tau_1$ and $\tau_2$ partitions the model into three sections: $\frac{de_x}{dt} \sim \alpha$ where $t \lt \tau_1$, $\frac{de_x}{dt} \sim \alpha + \beta_1$ where $\tau_1 \le t \lt \tau_2$, and $\frac{de_x}{dt} \sim \alpha + \beta_2$ where $t \ge \tau_2$. As $\tau_1 \lt \tau_2$, only values of $\tau_2$ which are greater than $\tau_1$ are considered. Otherwise all whole integer values of $\tau$ are seached through for both $M_1$ and $M_2$. 


For any particular population $D_i$, we should generally expect a high degree of concordance between the breakpoint or breakpoints identified by the `segmented` package, and the changepoint or changepoints identified using annual changes in life expectancy against time. However, we should not expect the results from the two approaches to be identical, due to differences in the algorithms used to select the best model parameters. 

The above analyses are performed for each population group, comprising different combinations of country, sex, and starting age. 

    

# A slight pivot 

I've realised a better use of the segmented package may be to identify and compare zero breakpoint, one breakpoint, and two breakpoint models. The code below will do this 

```{r}


estimate_breakpoints_and_pval <- function(df){
  null_mdl <- lm(ex ~ year, data = df) 
  seg_mdl <- segmented::segmented(null_mdl, seg.Z= ~year, psi = 2010)
  seg2_mdl <- segmented::segmented(null_mdl, seg.z= ~year, psi= c(1985, 2010)) # added to test

  list(
    null = null_mdl, 
    seg = seg_mdl,
    seg2 = seg2_mdl
  )
}

segmented_breakpoints_models <- 
  hmd_ex_selected_countries_with_synth %>% 
  filter(code != "DEUTNP") %>%   
  filter(year >= 1979) %>% 
  group_by(code, x, sex) %>% 
  nest() %>% 
  mutate(
    mdl_outputs = map(data, estimate_breakpoints_and_pval)
  ) %>% 
  unnest_longer(mdl_outputs) 


# Now let's get the BIC for each model 

make_predictions <- function(mdl, dta = tibble(year = 1980:2020)){
  tibble(
    year = dta$year, 
    ex_pred = predict(mdl, newdata = dta)
  )
}

best_model_predictions_descriptions <- 
segmented_breakpoints_models %>% 
  mutate(bic = map_dbl(mdl_outputs, BIC)) %>% 
  group_by(code, x, sex) %>% 
  mutate(rank_bic = rank(bic)) %>%
  filter(rank_bic == 1) %>% 
  mutate(
    best_model = case_when(
      mdl_outputs_id == 'seg2' ~ "Two breakpoints",
      mdl_outputs_id == 'seg'  ~ "One breakpoint", 
      mdl_outputs_id == 'null' ~ "No breakpoints"
    )
  ) %>% 
  mutate(
    first_breakpoint =    map2_dbl(
      mdl_outputs_id, mdl_outputs, 
      function(x, y){
        if (x == 'null'  ) {NA_real_} else {
          y[["psi"]][1,2]
        }
      }                        
      ),
      first_breakpoint_se = map2_dbl(
        mdl_outputs_id, mdl_outputs,
        function(x, y){
        if (x == 'null'  ) {NA_real_} else {
          y[["psi"]][1,3]
        }
          
        }
      ),
    second_breakpoint = map2_dbl(
      mdl_outputs_id, mdl_outputs,
      function(x, y){
        if (x == 'seg2') {
          y[["psi"]][2,2]
        } else  {
            NA_real_
          }
      }                           
      ),
    second_breakpoint_se = map2_dbl(
      mdl_outputs_id, mdl_outputs,
      function(x, y){
        if (x == 'seg2') {
          y[["psi"]][2,3]
        } else  {
            NA_real_
          }
      }
    )
  ) %>%  # let's add predictions too 
  mutate(
    pred_data = map(mdl_outputs, make_predictions),
    joined_data = map2(data, pred_data, left_join)
  ) %>% 
  select(code, x, sex, joined_data, first_breakpoint:second_breakpoint_se) %>% 
  unnest(joined_data)

```


I want to save segmented_breakpoints_models so I can explore it in an app 

```{r}
write_rds(segmented_breakpoints_models, here("apps", "compare_cps_and_bps", "data", "segmented_models.rds"))

```


Let's visualise 

```{r}
best_model_predictions_descriptions %>% 
  filter(x == 0) %>% 
  ggplot(aes(x = year, colour = sex)) + 
  geom_point(aes(y = ex, shape = sex), alpha = 0.25) + 
  geom_line(aes(y = ex_pred)) + 
  facet_wrap(~code) +
  geom_vline(aes(xintercept = first_breakpoint, colour = sex)) + 
  geom_vline(aes(xintercept = second_breakpoint, colour = sex)) + 
  labs(
    x = "Year", y = "Life expectancy at birth (years)",
    title = "Breakpoint models for selected countries"
  )
  
# Or monochrome

best_model_predictions_descriptions %>% 
  filter(x == 0) %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = ex), alpha = 0.25) + 
  geom_line(aes(y = ex_pred)) + 
  facet_grid(sex~code) +
  geom_vline(aes(xintercept = first_breakpoint)) + 
  geom_vline(aes(xintercept = second_breakpoint)) + 
  labs(
    x = "Year", y = "Life expectancy at birth (years)",
    title = "e0, Breakpoint models for selected countries"
  )

ggsave(here("figures", "best_0to2bp_e0.png"), height = 20, width = 30, units = "cm", dpi = 150)

```

I think the monochrome display works better, as there's too many vertical lines otherwise. 

And the same for conditional life expectancy

```{r}
best_model_predictions_descriptions %>% 
  filter(x == 65) %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = ex), alpha = 0.25) + 
  geom_line(aes(y = ex_pred)) + 
  facet_grid(sex~code) +
  geom_vline(aes(xintercept = first_breakpoint)) + 
  geom_vline(aes(xintercept = second_breakpoint)) + 
  labs(
    x = "Year", y = "Life expectancy at age 65 (years)",
    title = "e65, Breakpoint models for selected countries"
  )

ggsave(here("figures", "best_0to2bp_e65.png"), height = 20, width = 30, units = "cm", dpi = 150)

```
I think we can show how the gradients are predicted to change by differencing again 

```{r}
best_model_predictions_descriptions %>% 
  filter(x == 0) %>% 
  group_by(code, x, sex) %>% 
  arrange(year) %>% 
  mutate(
    ch_ex = ex - lag(ex),
    ch_ex_pred = ex_pred - lag(ex_pred)
    ) %>% 
  ungroup() %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = ch_ex), alpha = 0.25) + 
  geom_step(aes(y = ch_ex_pred), direction = "vh") + 
  facet_grid(sex~code) + 
  geom_hline(yintercept = 0) + 
  geom_ribbon(
    aes(
      ymin = ifelse(ch_ex_pred < 0, ch_ex_pred, 0), 
      ymax = ifelse(ch_ex_pred < 0, 0, ch_ex_pred),
      fill = ch_ex_pred < 0
      ),
    alpha = 0.2
    ) + 
  scale_fill_manual(values = c(`TRUE` = 'red', `FALSE` = 'blue')) +
  guides(fill = "none") + 
  labs(
    x = "Year", y = "Annual change in life expectancy at birth",
    title = "Annual change in life expectancy at birth, with implied changes from breakpoint models",
    subtitle = "Breakpoint models calculated using segmented package and selected using BIC",
    caption = "Lines are from breakpoint models; these are 'kinked' because slopes are for single years, not changes between years"
  )

ggsave(here("figures", "best_0to2bp_change_e0.png"), height = 20, width = 30, units = "cm", dpi = 150)

```
```{r}
best_model_predictions_descriptions %>% 
  filter(x == 65) %>% 
  group_by(code, x, sex) %>% 
  arrange(year) %>% 
  mutate(
    ch_ex = ex - lag(ex),
    ch_ex_pred = ex_pred - lag(ex_pred)
    ) %>% 
  ungroup() %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = ch_ex), alpha = 0.25) + 
  geom_step(aes(y = ch_ex_pred), direction = "vh") + 
  facet_grid(sex~code) + 
  geom_hline(yintercept = 0) + 
  geom_ribbon(
    aes(
      ymin = ifelse(ch_ex_pred < 0, ch_ex_pred, 0), 
      ymax = ifelse(ch_ex_pred < 0, 0, ch_ex_pred),
      fill = ch_ex_pred < 0
      ),
    alpha = 0.2
    ) + 
  scale_fill_manual(values = c(`TRUE` = 'red', `FALSE` = 'blue')) +
  guides(fill = "none") + 
  labs(
    x = "Year", y = "Annual change in life expectancy at age 65",
    title = "Annual change in life expectancy at age 65, with implied changes from breakpoint models",
    subtitle = "Breakpoint models calculated using segmented package and selected using BIC",
    caption = "Lines are from breakpoint models; these are 'kinked' because slopes are for single years, not changes between years"
  )

ggsave(here("figures", "best_0to2bp_change_e65.png"), height = 20, width = 30, units = "cm", dpi = 150)

```

# Secondary confirmation 

I've reluctantly convinced myself that keeping two methods for estimating breakpoints, one using $y ~ t$, the other using $dy/dt ~ t$ (i.e. changepoint analysis) is still an important aspect of the paper. For the changepoint modelling I looked at each possible value of t (grid search, 1d). For two breakpoints I guess I should repeat the approach, but with all permutations (removing duplicates for t1 and t2). This might take a little while but should provide reassurance. 

```{r}
changepoint_breakpoints_models <- 
  hmd_ex_selected_countries_with_synth %>% 
  filter(code != "DEUTNP") %>%   
  filter(year >= 1979) %>% 
  group_by(code, x, sex) %>% 
  nest() %>% 
  mutate(
    mdl_outputs = map(data, get_best_taus_from_gridsearch, what = "all")
  )


```

Let's try to make sense of this 

```{r}
changepoint_breakpoints_models %>% 
  unnest(mdl_outputs) %>% 
  group_by(code, x, sex) %>% 
  mutate(bic_std = (bic - min(bic)) / (max(bic) - min(bic))) %>% 
  ggplot(aes(x = tau1, y = tau2, colour = bic_std, fill = bic_std)) + 
  geom_raster() + 
  facet_wrap(~ code + sex + x, ncol = 8) + 
  scale_color_viridis_c() + 
  geom_point(colour= 'red', 
             data = changepoint_breakpoints_models %>% 
              unnest(mdl_outputs) %>% 
              group_by(code, x, sex) %>% 
              mutate(bic_std = (bic - min(bic)) / (max(bic) - min(bic))) %>% 
              filter(bic_std == min(bic_std))
  ) + 
  coord_fixed() +
  theme(axis.text.x = element_text(angle = 90))
```

For a number of populations, the red points (lowest aics) are just slightly off the diagonal, implying something like a single changepoint model. This can be tested further by seeing if those 2 cp models that are near the diagonal tend to get outcompleted with a 1 cp model. 
There are also models with horizontal dark lines, implying indifference to the second value. Once again these are likely (perhaps?) to be outcompleted with the 1 cp models. 

So, let's get the one CP models, and the associated BIC. (I have changed the default returned to BIC from AIC)

```{r}
changepoint_breakpoint_models <- 
  hmd_ex_selected_countries_with_synth %>% 
  filter(code != "DEUTNP") %>%   
  filter(year >= 1979) %>% 
  group_by(code, x, sex) %>% 
  nest() %>% 
  mutate(
    mdl_outputs = map(data, get_best_tau_from_gridsearch, what = "all")
  )

```

Now let's compare 1cp with 2cp 

```{r}
estimate_null <- function(df){
  df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    filter(!is.na(delta_ex)) %>% 
    lm(delta_ex ~ 1, data = .)
}

compare_bic_cps <- 
  hmd_ex_selected_countries_with_synth %>% 
    filter(code != "DEUTNP") %>%   
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    nest() %>% 
    mutate(
      mdl_0 = map(data, estimate_null),
      bic_0    = map_dbl(mdl_0, BIC)
    ) %>% 
    select(code, x, sex, mdl_0, bic_0) %>% 
    left_join(
      changepoint_breakpoint_models %>% 
        unnest(mdl_outputs) %>% 
        group_by(code, x, sex) %>% 
        filter(bic == min(bic)) %>% 
        select(code, x, sex, tau1 = tau, bic_1 = bic)  
    ) %>% 
    left_join(
      changepoint_breakpoints_models %>% 
        unnest(mdl_outputs) %>% 
        group_by(code, x, sex) %>% 
        filter(bic == min(bic)) %>% 
        select(code, x, sex, tau1_2 = tau1, tau2_2 = tau2, bic_2 = bic)
    ) %>% 
  select(-mdl_0) %>% 
  ungroup() # %>% 
#  write.csv("tmp.csv")
```

The results are mixed. Generally the 2cp model preferred to the 1cp model, and only rarely is the 0cp model preferred. For *most* of the populations, the 2cp and 1cp model contain a tau either identical to or one year apart from each other. This is reassuring. 

- Germany East, female, 0: no close match (2)
- Germany East, female, 65: 1987 for both (2)
- Germany East, male, 0: 1991 for both (2) 
- Germany East, male, 65: 1991 for both (2)
- Germany West, female, 0: 1988 for both (1)
- Germany West, female, 65: no close match (2)
- Germany West, male, 0: No close match (2)
- Germany West, male, 65: 2015 for both (2)
- SynthGermany, male, 0: no match (1)
- SynthGermany, male, 65: 2015 for both (1) 
- SynthGermany, female, 0: no match (1)
- SynthGermany, female, 65: no match (2)
- Spain, female, 0: 1983 for both (2 but close)
- Spain, female, 65: 0cp preferred (0)
- Spain, male, 0: 1983 for both (2)
- Spain, male, 65: 0cp preferred (0)
- France, female, 0: No close match (2)
- France, female, 65: No close match (2)
- France, male, 0: No clear match (2)
- France, male, 65: No clear match (2)
- Italy, female, 0: 2005 for both (2)
- Italy, female, 65: 2005 for both (2)
- Italy: male, 0: 0cp preferred (0)
- Italy, male, 65: No close match (2)
- England & Wales, female, 0: 2012 for both (1)
- England & Wales, female, 65: No close match (0)
- England & Wales, male, 0: 2012/13 (1)
- England & Wales, male, 65: 2012 (2)
- Scotland, male, 0: 2015 in both (1)
- Scotland, male, 65: 1994 in both (2)
- Scotland, female, 0: no close match (2)
- Scotland, female, 65: no close match (0)

For three of the four England & Wales population, a breakpoint is consistently identified at around 2012.

Now I want to know whether the estimates are about the same whether 1cp or 2cp used. 




```{r}

run_tau_1 <- function(tau, df){
  df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    filter(!is.na(delta_ex)) %>% 
    mutate(T_param = ifelse(year < tau, FALSE, TRUE)) %>% 
    lm(delta_ex ~ T_param, data = .)
}

run_tau_2 <- function(tau1, tau2, df){
  df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    filter(!is.na(delta_ex)) %>% 
    mutate(T_param = ifelse(
      year < tau1, 
      "bp0", 
      ifelse(
        year < tau2, "bp1", "bp2"
        )
      )
    ) %>% 
    lm(delta_ex ~ T_param, data = .)
}

make_path_coords <- function(df, taus = NULL, mdl){
  stopifnot(
    "wrong number of coefficients for the model type" = 
    length(coefficients(mdl)) == length(taus) + 1
  )

  min_x = min(df$year)
  max_x = max(df$year)
  
  coeffs <- coefficients(mdl)
  
  y0 <- coeffs[1]

  out <- tribble(
    ~x, ~y,
    min_x, y0
  )
  
  if(length(coeffs) == 1){
    out <- out %>%
      bind_rows(
        tribble(
          ~x, ~y,
          max_x, y0
        )
      )
    return(out)
    
  } else if (length(coeffs) == 2){
    out <- out %>% 
      bind_rows(
        tribble(
          ~x, ~y,
          taus[1], y0,
          taus[1], y0 + coeffs[2],
          max_x, y0 + coeffs[2]
        )
      )
    return(out)
    
  } else if (length(coeffs) == 3){
    out <- out %>% 
      bind_rows(
        tribble(
          ~x, ~y,
          taus[1], y0,
          taus[1], y0 + coeffs[2],
          taus[2], y0 + coeffs[2],
          taus[2], y0 + coeffs[3],
          max_x, y0 + coeffs[3]
          
        )
      )
    
    return(out)
  }
  return(NULL) # should not be triggered  
}

# Let's try this with 0cp

paths_0cp <- 
  hmd_ex_selected_countries_with_synth %>% 
    filter(code != "DEUTNP") %>%   
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    nest() %>% 
    mutate(
      mdl_0 = map(data, estimate_null)
    ) %>% 
    mutate(bic = map_dbl(mdl_0, BIC)) %>% 
    mutate(
      tau_paths = pmap(.l = list(df = data, mdl = mdl_0), make_path_coords)
    ) %>% 
  select(code, x, sex, bic_0cp = bic, paths_0cp = tau_paths)

# Now 1cp
paths_1cp <- 
  changepoint_breakpoint_models %>% 
    unnest(mdl_outputs) %>% 
    group_by(code, x, sex) %>% 
    filter(bic == min(bic)) %>% 
    ungroup() %>% 
    mutate(
      mdl_with_best_1cp = map2(tau, data, run_tau_1)
    ) %>% 
    mutate(
      tau_paths = pmap(
        .l = list(
          df = data, 
          mdl = mdl_with_best_1cp, 
          taus = c(tau)
        ), 
        make_path_coords
      )
    ) %>% 
    select(
      code, x, sex, bic_1cp = bic, paths_1cp = tau_paths
    )

# and now for 2cp
paths_2cp <- 
  changepoint_breakpoints_models %>% 
    unnest(mdl_outputs) %>% 
    group_by(code, x, sex) %>% 
    filter(bic == min(bic)) %>% 
    ungroup() %>% 
    mutate(mdl_with_best_2cp = pmap(.l = list(tau1=tau1, tau2=tau2, df=data), run_tau_2)) %>%
    mutate(taus = map2(tau1, tau2, c)) %>% 
    mutate(
      tau_paths = pmap(
        .l = list(
          df = data, 
          mdl = mdl_with_best_2cp, 
          taus = taus
        ), 
        make_path_coords
      )
    ) %>% 
    select(code, x, sex, bic_2cp = bic, paths_2cp = tau_paths)
  

```

Let's now see how the three compare

```{r}

reduce(list(paths_0cp, paths_1cp, paths_2cp), left_join) %>% 
  rename(start_age = x) %>% 
  pivot_longer(cols = starts_with(c("path", "bic")), names_to = c(".value", "path_type"), names_sep = "_") %>% 
  group_by(code, start_age, sex) %>% 
  mutate(
    bic_rank = as.character(rank(bic))
  ) %>% 
  ungroup() %>% 
  unnest(paths) %>% 
  filter(code == "ESP") %>% 
#  filter(start_age == 65) %>% 
  ggplot(aes(x, y, group = path_type, colour = path_type, linetype = bic_rank, alpha = bic_rank)) + 
  geom_path() + 
  facet_grid(start_age~sex) + 
  expand_limits(y  = 0) + 
  geom_hline(yintercept = 0) +
  scale_alpha_manual("BIC", values = c("1" = 1.0, "2" = 0.5, "3" = 0.25)) +
  scale_linetype_manual(values = c("1" = "solid", "2" = "dashed", "3" = "dashed")) + 
  guides(alpha = FALSE, linetype = FALSE) + 
    geom_point(
    aes(x = year, y = ch_ex), 
    inherit.aes = FALSE,
    data =   hmd_ex_selected_countries_with_synth %>%
      rename(start_age = x) %>% 
      filter(code == "ESP") %>%
      group_by(sex, start_age) %>% 
      arrange(year) %>% 
      mutate(ch_ex = ex - lag(ex)) %>% 
      ungroup() %>% 
      filter(year >= 1979)
               
  )

```
It looks like the 2cp model is sometimes 'flexing' to pick up a distinct year with especially high or low mortality. This is consistent with infectious diseases but more an impulse rather than a step-change, which is what we are interested in. 

I think I'd like to try to make this interactive with a simple (!) shiny app. 

What specific files do I need to save? 

```{r}
cp_paths <- 
  reduce(list(paths_0cp, paths_1cp, paths_2cp), left_join) %>% 
    rename(start_age = x) %>% 
    pivot_longer(cols = starts_with(c("path", "bic")), names_to = c(".value", "path_type"), names_sep = "_") %>% 
    group_by(code, start_age, sex) %>% 
    mutate(
      bic_rank = as.character(rank(bic))
    ) %>% 
    ungroup() %>% 
    unnest(paths)

write_rds(cp_paths, here("apps", "compare_cps", "data", "cp_paths.rds"))

write_rds(hmd_ex_selected_countries_with_synth, here("apps", "compare_cps", "data", "countries_data.rds"))

```


I would like to plot the above with the data too, and to plot these as figures

```{r eval = FALSE}

# Let's start with just a single population, and the figure created for England & Wales at age 0

g_path <- 
  reduce(list(paths_0cp, paths_1cp, paths_2cp), left_join) %>% 
    rename(start_age = x) %>% 
    pivot_longer(cols = starts_with("path"), names_to = "path_type", names_prefix = "paths_", values_to = "df") %>% 
    unnest(df) %>% 
    filter(code == "GBRTENW") %>% 
    filter(start_age == 0) %>% 
    ggplot(aes(x, y, group = path_type, colour = path_type), alpha = 0.6) + 
    geom_path() + 
    facet_wrap(~sex) + 
    expand_limits(y  = 0) + 
    geom_hline(yintercept = 0) 

g_path

# Now the points 

g_points <- 
  hmd_ex_selected_countries_with_synth %>%
  rename(start_age = x) %>% 
  filter(code == "GBRTENW") %>%
  filter(start_age == 0) %>%
  group_by(sex) %>% 
  arrange(year) %>% 
  mutate(ch_ex = ex - lag(ex)) %>% 
  ungroup() %>% 
  filter(year >= 1979) %>% 
  ggplot(aes(x = year, y = ch_ex)) + 
  facet_wrap(~sex) + 
  geom_point()

g_points

g_path + g_points

g_path + 
  geom_point(
    aes(x = year, y = ch_ex), 
    inherit.aes = FALSE,
    data =   hmd_ex_selected_countries_with_synth %>%
      rename(start_age = x) %>% 
      filter(code == "GBRTENW") %>%
      filter(start_age == 0) %>%
      group_by(sex) %>% 
      arrange(year) %>% 
      mutate(ch_ex = ex - lag(ex)) %>% 
      ungroup() %>% 
      filter(year >= 1979)
               
  )

# I think I also want to know which cp has the lowest BIC



```
# Summary of differences and similarities between segmented approach and changepoint approach

In order to compare the results of the two modelling approaches, an R shiny app was built. This app allows each of the countries of interest to be selected, and has three tabs for different displays. These tabs are labelled: 'Segmented', which shows the results of the segmented regression approach; 'Changepoints', which shows the result of the changepoint approach; and both, which compares the best performing segmented and changepoint models. For each country, the results are shown as a two-by-two array, with each sex a different column and each row a different starting age. An option is provided to show the data for the populations, from which the models are derived. 

For both the Segmented and Changepoint displays, polylines are shown for the best performing zero, one or two break models. Of these three models, the model with the lowest BIC is shown as a thick, solid line of full opacity, and the other two lines are shown as broken lines with some level of transparency. This means the polyline corresponding to the best-performing model should be the most prominent of the series of polylines shown. 


For England & Wales, the segmented approach identified a two breakpoint model has having the lowest BIC, for all four combinations of sex and starting age. These two breakpoint models suggest a moderate level of annual increase throughout the 1980s and 1990s, a further increase throughout the late 1990s/early 2000s, then a consistent and severe decrease in average annual rate of improvement after around 2012. The corresponding changepoint approach identified a one changepoint model for both males and females from birth, a two changepoint model for males from age 65 years, and a zero changepoint model for females from age 65. Despite these apparent differences between approaches, three of the four changepoint models identify a substantive decrease in the rate of annual improvement around or soon after 2012. Comparison of the best-performing changepoint and segmented model shows that, despite differences in the number of breaks identified, the two types of model tend to show similar patterns over time. 

For Scotland, the segmented model identifies a two breakpoint model as having the lowest BIC for males and females from age 65, and males from birth. Each of these models are qualitatively similar to those for England & Wales, with an increase in the rate of improvement from the late 1990s/early 2000s to around 2012, then a decrease in the rate of improvement thereafter; for males from birth the average annual rate of improvement after around 2013 is estimated to be negative (i.e. declining mortality trends rather than stalling mortality trends). For females from birth a one breakpoint model is identified, which also estimates a negative average improvement (i.e. falling life expectancy) after around 2014. 

Unlike with England & Wales, the changepoint approach leads to results which are not highly concordant with those produced using the segmented approach. This appears to be because, when the two changepoint model is used, the two points identified can be a single year apart, and  for females from birth and males from age 65, they are. Because the data used are for single years, rather than averaged across a number of years, a single point can be substantially higher or lower than the general trend. This can be due to factors such as especially mild winters for years with exceptionally high values, or especially cold winters, or hot summers, or especially infectious and pathogenic strains of infectious disease for years with exceptionally low or negative values. By fitting two changepoints one year apart, the algorithm is in effect identifying and removing the effect of these outlier years from the estimate of the trends either side. For smaller populations like Scotland, these outliers are likely to be more severe than for larger populations like England & Wales, which may explain the identification of such outlier years within the changepoint analysis in Scotland but not England & Wales.    

For Italy, a slowdown in gains in life expectancy is identified by the segmented approach for both sexes from birth, and for females from age 65. This slowdown was estimated to have occurred around 2006. For males from birth, like with England & Wales, a two breakpoint model with a period of faster improvement rates - starting in the late 1990s and ending around 2006 - was also identified. For males from age 65 a zero breakpoint model was preferred. For the changepoint analysis, as with Scotland, a two changepoint specification was preferred to other specifications for females of both starting ages, and for males from age 65. This identified an outlier, of exceptionally fast improvement, in 2004-5, which is adjacent to two years of negative change in 2003-04 and 2005-06. For females, the average trend after this outlier was estimated to be slightly below that of the preceding period, providing some indication of a slowdown in life expectancy around 2005. 

For Spain, the segmented approach shows a modest slowdown in annual improvements after 2012 or slightly later for females of both starting ages, and males from age 65. For males from birth a two breakpoint model is identified, but which identifies a short period in the late 1980s as one of modest decline in life expectancy, then a continued period of improvement thereafter. For the changepoint approach, a zero changepoint model was preferred for both females and males from age 65, whereas for life expectancy from birth a two changepoint model, identifying a single year or short period of years as being of negative or negligible improvement in life expectancy during 1984-85 (females), or much of the 1980s (males), was preferred instead. When comparing the preferred changepoint with breakpoint models, the breakpoint models were generally able to identify a slowdown in the 2010s, whereas the changepoint models were not. 

For Germany (total, synthetic), the preferred segmented models all included a decline in improvement in the latter half of the period considered. For females at both starting ages, and for males from birth, this slowdown was identified to have occurred from around 2006/2007, whereas for males from age 65 to have occurred from 2010. For males from both starting ages, however, two breakpoint models were preferred, with faster rates of improvement identified from the mid 1990s, and the decline in life expectancy gains largely a return to prior trends more common in the 1980s and first half of the 1990s. The results from the changepoint approach are somewhat discordant, through all identify some slowdown in rates of improvement at the end of the series compared with the start. 

For France, the segmented approach estimates a slowdown in life expectancy improvements beginning from around 2011 (female, from age 65) to 2013 (female, from birth). For males two breakpoint models including a slight period of more rapid improvment in the 2000s are preferred, whereas for females either a single breakpoint model (from age 65) or two breakpoints of successive decline in improvement (from birth, the first breakpoint being in 2011-12) were instead identified. The changepoint models indicated a preference for the two changepoint specification, but for all four populations these functioned as outlier detectors, identifying the year 2004-05 as one in which especially rapid improvement occurred (surrounded by two years of especially low improvement); for three of the four changepoint models, a lower rate of average improvement was predicted at the end of the series than at the start, though this slowed rate of improvement was much less than for England & Wales. 

## Discussion relating to above 

Though there are some important differences between the number, position and magnitude of breakpoints and changepoints produced using the two approaches, these largely appear to be explicable in terms of differences between how the breakpoints/changepoints were identified. More specifically, for some populations the changepoint approach identified changepoints that were a single year apart, and correspond to years in which the annual change in values were either especially high or especially low compared with surrounding years. In effect, such changepoint models functioned as a kind of outlier removal system, removing a single value from a longer series in order to allow the gradient/intercept to better fit remaining values. Although this feature was not the intended aim when producing the changepoint analysis, it is clear from looking at annual changes in life expectancy that some annual changes are outliers; especially large annual improvements can be caused by some combination of particularly favourable climactic and infectious disease conditions (relatively mild summers and winters; strains of seasonal influenza with relatively low infectivity and/or pathogenicity, perhaps due to effective vaccination campaigns), and especially modest or negative annual improvements can be caused by the converse. It is important to note that, when looking at unsmoothed annual data, individual years in which life expectancy was lower than in the preceding year are, though infrequent, not uncommon, and may be expected to occur once or more over the full series of years over which the analyses are performed. Furthermore, outlier years can be expected to be more extreme, and more frequent, for smaller populations than larger populations, which appears to explain differences between the best changepoint model for Scotland as compared with England & Wales. Additionally, because of phenomena including forward mortality displacement and acquired immunity, especially 'bad' and 'good' years should not be expected to be independently distributed, but instead (negatively) predictive of each other. More precisely, annual life expectancy series oscillate slightly, rather than are an entirely random process. (This can be demonstrated by showing that ARIMA(1,1,0) models tend to fit the data slightly better than ARIMA(0,1,0) models.)

Regardless, the results taken together provide good evidence that England & Wales experienced a substantial decline in rates of annual mortality improvement (i.e. stalling) after around 2012, as well as fairly good evidence that Scottish populations may have experienced a decline as or more severe contemporaneously. For Scotland, the segmented regression approach implies that life expectancy has fallen, rather than simply stalled, in recent years; however the greater discordance between the results of the segmented and changepoint approaches, and smaller population size for Scotland compared with England & Wales, suggests the estimates for Scotland may be less reliable than those for England & Wales. 

For England & Wales, there appears to be fairly good evidence that two apparently 'competing' interpretations of life expectancy trends are both correct: i.e. that it is both true that the late 1990s and 2000s were a period of unusually rapid average improvements in life expectancy, *and* that after around 2012 there has been a fairly severe stalling of such annual gains. This finding, based on a data series starting 1979-80, is an important contribution to the evidence base supporting the stalling life expectancy hypothesis, because a number of previous analyses used data starting in the late 1990s or early 2000s (EXAMPLES?). Without the longer time series considered here, such earlier analyses would not have been able to discount the possibility that any breakpoint identified around 2010/2 or thereabouts represents a return to earlier trends of more modest improvement, rather than the emergence of a new trend of unusually low longevity gains. 

The analyses presented here also reveal some similarities and differences between England & Wales and other European nations. In particular, we can see that England & Wales was not the only population where the segmented regression approach identified a two breakpoint model as preferable to a zero or one breakpoint model, and where the two breakpoint model identified included both a period of increased, and then a period of decreased, improvement in life expectancy trends as compared with the initial period. When looking at trends in life expectancy change from birth, this jump-then-fall pattern is identified in Italy, Germany (combined) and to a lesser extent France for males, though not for females. And when looking at comparable trends in conditional life expectancy change from age 65, a jump-then-fall pattern is evident in Spain, France, Germany, again for males only. When looking at females, the fall component of this pattern was identified in Germany, Spain, France and Italy, but the jump component seen in males was not; this appears to be the case both for trends in life expectancy from birth, and from age 65. 

Though the presence of a fall component - i.e. a reduced rate of improvement starting in the late 2000s or early 2010s - was identified in these other European nations as well as England & Wales, in England & Wales the extent of the recent fall appears to be more uniform across population subgroups, more consistently identifiable using the two methods applied here, and more severe than in the other European comparator nations. Within Scotland, despite a smaller population and greater discordance between the segmented and changepoint methods, there are indications that life expectancy may be falling, rather than simply 'stalling', with the trend in annual changes in life expectancy from birth being negative for both males and females. (It should also be noted that, for females, the French trends from birth are also close to zero.)

In summary, it appears that patterns in life expectancy change over time are *not qualitatively* dissimilar in England & Wales (and Scotland) as compared with other Continental European nations, but are *quantitatively* dissimilar in terms of both the increase in rate of improvement in trends during the late 1990s and 2000s, and the severity of the *fall* in improvement in trends seen since around 2012. Put more simply, it appears that what has occurred in England & Wales has also occurred in other European nations, only *more so*. This suggests that factors specific to England & Wales (and with more uncertainty, Scotland too) may have exacerbated tendencies -towards both increase and decrease in trends - also present in comparable national populations. 




```{r}
# For 0cp
hmd_ex_selected_countries_with_synth %>% 
  filter(code != "DEUTNP") %>%   
  filter(year >= 1979) %>% 
  group_by(code, x, sex) %>% 
  nest() %>% 
  mutate(
    mdl_0 = map(data, estimate_null)
  ) %>% 
  mutate(
    tdy_mdl_0 = map(mdl_0, broom::tidy)
  ) %>% 
  select(code, x, sex, tdy_mdl_0) %>% 
  unnest(tdy_mdl_0)

# For 1cp
changepoint_breakpoint_models %>% 
  unnest(mdl_outputs) %>% 
  group_by(code, x, sex) %>% 
  filter(bic == min(bic)) %>% 
  ungroup() %>% 
  mutate(
    mdl_with_best_1cp = map2(tau, data, run_tau_1)
  ) %>% 
  mutate(
    tdy_mdl_with_1cp = map(mdl_with_best_1cp, broom::tidy)
  ) %>% 
  select(code, x, sex, tau, tdy_mdl_with_1cp) %>% 
  unnest(tdy_mdl_with_1cp)


# for 2cp

changepoint_breakpoints_models %>% 
  unnest(mdl_outputs) %>% 
  group_by(code, x, sex) %>% 
  filter(bic == min(bic)) %>% 
  ungroup() %>% 
  mutate(mdl_with_best_2cp = pmap(.l = list(tau1=tau1, tau2=tau2, df=data), run_tau_2)) %>%
  mutate(tdy_mdl_with_best_2cp = map(mdl_with_best_2cp, broom::tidy)) %>% 
  select(code, x, sex, tau1, tau2, tdy_mdl_with_best_2cp) %>% 
  unnest(tdy_mdl_with_best_2cp) 

#So, what's the best way to turn these into graphical instructions? 

# For the first one, we want 
# {x, y}
# {1980, 0.13}
# {1991, 0.13}
# {1991, 0.13 + 0.30}
# {2002, 0.13 + 0.30}
# {2002, 0.13 + 0.01}
# {2015, 0.13 + 0.01}


```




```{r, eval = FALSE}
estimate_breakpoint_and_pval_change <- function(df){
  null_mdl <- lm(delta_ex ~ year, data = df) 
  seg_mdl <- segmented::segmented(null_mdl)   
  anova_diff <- anova(null_mdl, seg_mdl)
  
  list(
    null = null_mdl, 
    seg = seg_mdl,
    diff = anova_diff
  )
}

segmented_breakpoint_models_change <- 
  hmd_ex_selected_countries_with_synth %>% 
    filter(code != "DEUTNP") %>% 
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    filter(!is.na(delta_ex)) %>% 
    nest() %>% 
    mutate(
      mdl_outputs = map(data, estimate_breakpoint_and_pval_change)
    ) %>% 
    unnest_wider(mdl_outputs) %>% 
    mutate(
      ftest_pval = map_dbl(diff, ~.[2,6]),
      stat_sig_preference = ftest_pval < 0.05
    ) %>% 
    mutate(
      breakpoint = map_dbl(seg, ~.[["psi"]][1,2]),
      breakpoint_se = map_dbl(seg, ~.[["psi"]][1,3])
    )

segmented_breakpoint_models_change



```



### Table of countries breakpoints with statistical significace

Next, we display a table with those countries where the breakpoint shows as statistically significant (at p value <0.05) compared to the null, where best_tau is the year.

```{r, eval = FALSE}
stat_sig_table <- select(tmp, code, x, sex, best_tau, ftest_pval, stat_sig_preference) %>% arrange(ftest_pval)

#arrange(stat_sig_table, ftest_pval)

view(stat_sig_table)

colnames(stat_sig_table) = c("Country", "Age", "Sex", "Best_Tau", "F Test P Value", "Statistically significant")



  #filter(stat_sig_preference==TRUE) %>% 
  
#using flextable
myft <- flextable(stat_sig_table)
myft <- theme_vanilla(myft)

# #myft <- flextable(stat_sig_table) %>%
#   compose(j = "Statistically significant",
#           value = as_paragraph(
#             as_chunk("TRUE",
#                      props = fp_text_default(color = "#C32900", bold = TRUE))))

myft
```

Next, let's look closer at France, Scotland, and E&Ws life expectancy at birth for males.



```{r}
example_df <- 
  hmd_ex_selected_countries_with_synth %>% 
      filter(x == 0) %>% 
      filter(sex == "male") %>% 
      filter(code == "FRATNP") %>% 
      filter(year >= 1979)
example_df <- 
  example_df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex))
grid_search_df <- tibble(
  tau_candidate = 1982:2015
) %>% 
  mutate(
    model_alt = map(tau_candidate, run_alt_with_given_tau, df = example_df)
  ) %>% 
  mutate(
    aic = map_dbl(model_alt, AIC)
  )
grid_search_df %>% 
  ggplot(aes(tau_candidate, aic)) + 
  geom_point()
```


# Discussion

- **Limitations**: fewer years for comparison in 2010s for some nations; comparing different time periods will provide different results e.g. New Labour years in E&W.

# Appendix A: Construction of Synthetic Germany 

- Add further details here. 

# Bibliography


# Dream Graphs 

To finally complete these, without getting distracted/stuck on how to double check and improve upon the underlying data/models 

- [ ] I've finally remembered that I can get the breakpoints by aggregating up the changes, as I've done many times previously! 

## Graph of ex against year, predicted and observed. 

```{r eval = FALSE}
# Start with Scotland, female, 0 

test_data <- compare_best_breakmodel_with_null %>% 
  filter(code == "GBR_SCO", x == 0, sex == "female") %>% 
  pluck("data", 1)

test_data %>% 
  ggplot(aes(year, ex)) + 
  geom_point()

# Now to get the modelled estimates

compare_best_breakmodel_with_null %>% 
  filter(code == "GBR_SCO", x == 0, sex == "female") %>% 
  pluck("model_alt", 1) %>% 
  broom::tidy()

# So, we want the last year before the breakpoint, then to produce a line that just integrates the (Intercept) term as many years as we want to project forward for. 

# So, let's think of a function that makes a graph, and what inputs it needs 

show_counterfactual_figure <- function(df, best_tau, alt_model){
  # First we might want to estimate the intercept for the pre-slowdown portion 
  # while fixing the slope at that estimated by (Intercept) in the delta_ex model 
  
  pred_slope <- alt_model %>%  broom::tidy() %>% 
    filter(term == "(Intercept)") %>% 
    pluck("estimate")
  # 
  pred_slope_after <- alt_model %>% 
    broom::tidy() %>% 
    filter(term == "T_paramTRUE") %>% 
    pluck("estimate")
   
  pred_intercept <-  mean(df$ex - pred_slope * df$year)
  
  pred_intercept_at_tau <- pred_intercept - pred_slope_after * best_tau
  
  # I think I should use geom_area for the after part 
  df %>% 
    mutate(
      y_pred_before = pred_intercept + pred_slope * year,
      y_pred_after  = pred_intercept_at_tau + (pred_slope + pred_slope_after) * year
    ) %>% 
    mutate(
      y_pred_before = ifelse(year < best_tau, NA, y_pred_before),
      y_pred_after  = ifelse(year < best_tau, NA, y_pred_after)
    ) %>% 
    ggplot() + 
    geom_point(aes(year, ex)) + 
    geom_vline(xintercept = best_tau) + 
    geom_abline(intercept = pred_intercept, slope = pred_slope) + 
    geom_ribbon(aes(ymax = y_pred_before, ymin = y_pred_after, x = year), alpha = 0.5)
}

this_df <- compare_best_breakmodel_with_null %>% 
  filter(code == "GBR_SCO", x == 0, sex == "male") %>% 
  pluck("data", 1)

this_best_tau <- compare_best_breakmodel_with_null %>% 
  filter(code == "GBR_SCO", x == 0, sex == "male") %>% 
  pluck("best_tau")

this_model_alt <- compare_best_breakmodel_with_null %>% 
  filter(code == "GBR_SCO", x == 0, sex == "male") %>% 
  pluck("model_alt", 1)


show_counterfactual_figure(this_df, this_best_tau, this_model_alt) 

# Now to do for all 

# Let's also label and set axes intelligently 

add_labels_axes <- function(gg, country, start_age, sex, 
                            ylims = list(
                                birth = c(70, 95),
                                x65 = c(0, 25)
                              )
                            ){
  gg + 
    labs(
      x = "Year", 
      y = case_when(
        start_age == 0  ~ "Life expectancy at birth",
        start_age == 65 ~ "Life expectancy at age 65",
        TRUE            ~ NA_character_
      ),
      title = glue::glue("Life expectancy in {country}, at age {start_age}, for {sex}s"),
      subtitle = "Shaded areas show deviation from projected life expectancy before any breakpoint in trend", 
      caption = "Source: Human Mortality Database"
    ) + 
    expand_limits( 
      y = case_when(
        start_age == 0 ~ ylims[["birth"]],
        start_age == 65 ~ ylims[["x65"]],
        TRUE    ~ c(0, 90)
      )
    )
}

compare_best_breakmodel_with_null %>% 
  left_join(country_code_lookup) %>% 
  mutate(
    ggsegplot = pmap(
      .l = list(df = data, best_tau = best_tau, alt_model = model_alt),
      .f = show_counterfactual_figure
    ),
    ggsegplot = pmap(.l = list(gg = ggsegplot, country = country, start_age = x, sex = sex), add_labels_axes)
  ) %>% 
  mutate(NULL = walk(ggsegplot, print))

  

```

# Another attempt at a simple summary 

It could be we don't get a clear changepoint for some populations because the annual variance as a function of change is particularly large. This would be more an issue for smaller populations than larger populations. The changepoint can therefore be expressed as a standarised unit. 

```{r eval = FALSE}

mean_sd_chex <- 
  hmd_ex_selected_countries_with_synth %>% 
    filter(code %in% c("DEUTSYNTH", "GBRTENW", "GBR_SCO", "FRATNP", "ITA", "ESP")) %>% 
    filter(between(year, 1979, 2019)) %>% 
    filter(x == 0) %>% 
    group_by(code, sex) %>% 
    arrange(year) %>% 
    mutate(ch_ex = ex - lag(ex)) %>% 
    filter(!is.na(ch_ex)) %>% 
    summarise(
      mean_chex = mean(ch_ex),
      sd_chex   = sd(ch_ex)
    ) %>% 
    mutate(b = mean_chex / sd_chex) %>% 
    ungroup() %>% 
    arrange(desc(mean_chex)) 

mean_sd_chex

# Now to compare with the changepoint model 

get_chpt_coeffs <- function(x){
  tidied_coeffs <- broom::tidy(x)
  
  tibble(
    mean_chex_before = tidied_coeffs$estimate[1],
    sd_chex_before   = tidied_coeffs$std.error[1],
    mean_chex_after  = tidied_coeffs$estimate[2],
    sd_chex_after    = tidied_coeffs$std.error[2]
  )
}

broke_unbroke <- 
  mean_sd_chex %>% 
    left_join(
      compare_best_breakmodel_with_null %>% 
        ungroup() %>% 
        filter(x == 0) %>% 
        select(code, sex, best_tau, model_alt, ftest_pval) %>% 
        mutate(coeffs = map(model_alt, get_chpt_coeffs)) %>% 
        unnest(coeffs) %>% 
        select(-model_alt) 
    ) %>% 
    mutate(
      ch_as_ratio_of_mean_chex = mean_chex_after / mean_chex,
      pos_chex_after = mean_chex_before + mean_chex_after
    ) 


# now to visualise in a simple way 

expand_grid(
  year = 1980:2019,
  broke_unbroke
  ) %>% 
  mutate(
    broke_val = if_else(year < best_tau, mean_chex_before, mean_chex_before + mean_chex_after)
  ) %>% 
  left_join(
    hmd_ex_selected_countries_with_synth %>% 
      filter(code %in% c("DEUTSYNTH", "GBRTENW", "GBR_SCO", "FRATNP", "ITA", "ESP")) %>% 
      filter(between(year, 1979, 2019)) %>% 
      filter(x == 0) %>% 
      group_by(code, sex) %>% 
      arrange(year) %>% 
      mutate(ch_ex = ex - lag(ex)) %>% 
      filter(!is.na(ch_ex)) %>% 
      ungroup() %>% 
      select(code, year, sex, ch_ex)
  ) %>% 
  ggplot(aes(year)) +
  geom_hline(aes(yintercept = mean_chex)) + 
  geom_hline(yintercept = 0, size = 1.3) + 
  facet_grid(code ~ sex) +
  geom_ribbon(aes(ymin = mean_chex - sd_chex, ymax = mean_chex + sd_chex), alpha = 0.2) + 
  geom_ribbon(aes(ymin = mean_chex - 2 * sd_chex, ymax = mean_chex + 2 * sd_chex), alpha = 0.2) + 
  expand_limits(y = 0) + 
  geom_step(aes(y = broke_val, alpha = 1 - ftest_pval, linetype = ftest_pval < 0.05), colour = "red") + 
  geom_point(aes(y = ch_ex)) +
  scale_alpha_continuous(range = c(0, 1)) + 
  scale_linetype_manual(values = c("FALSE" = "dotted", "TRUE" = "solid")) + 
  guides(alpha = "none", linetype = "none")
  
```

