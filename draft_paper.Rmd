---
title: "How do changes in ex vary between countries?"
author: "Jon Minton"
date: "22/02/2022"
output:
  html_document: default
  word_document: default
---

# Introduction 

This notebook will compare annual changes in life expectancy at both birth ($e_0$) and at age 65 ($e_{65}$) in the UK and UK nations, with other select European nations, including a 'Synthetic Germany' created from a weighted average of East and West German data for common years. The method for creating this 'Synthetic Germany' is also described in this and linked documents. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Methods 

## Data 

Data were extracted from the [Human Mortality Database](https://mortality.org/) via the R package [`HMDHFDplus`](http://www.demogr.mpg.de/en/projects_publications/publications_1904/mpidr_technical_reports/reading_human_fertility_database_and_human_mortality_database_data_into_r_5438.htm). 

The following countries are included in the comparison:

- England & Wales (`GBRTENW`)
- Scotland (`GBR_SCO`)
- UK as a whole (`GBR_UK`)
- France (`FRANTP`)
- Spain (`ESP`)
- Italy (`ITA`)
- Germany
   - Total Germany (`DEUTNP`)
   - East Germany (`DEUTE`)
   - West Germany (`DEUTW`)
   - Simulated/Synthetic Germany
 

```{r, echo=FALSE}
# load packages

pacman::p_load(here, tidyverse)

# load data 

hmd_lt <- read_rds(here("data", "lifetables.rds"))

```


## Analysis 

For each of these countries, and for males and females separately, we are interested in the annual changes in life expectancy at birth ($e_0$) and life expectancy at age 65 ($e_{65}$), from 1980 to the last available year for each country. 

### Synthetic Germany 

- To maybe be moved to the appendix later 

To allow UK national trends to be compared with a single German population, we attempted to produce a 'Synthetic German' population with data for East and West Germany for years prior to reunification. We estimated that this 'Synthetic Germany' could be produced by using a weighted average of 20% East Germany, and 80% West German life expectancy trends. More precise estimates can be produced, and the methods used to reach this conclusion are detailed in Appendix X. 



```{r, echo = FALSE}

countries_of_interest <- c(
  "GBRTENW",
  "GBR_SCO",
  "GBR_UK",
  "FRATNP",
  "ESP",
  "ITA",
  "DEUTNP",
  "DEUTE", 
  "DEUTW"
)

hmd_ex_selected_countries <- 
  hmd_lt %>% 
    filter(code %in% countries_of_interest) %>% 
    filter(Age %in% c(0, 65)) %>% 
    select(code, Year, Age, sex, ex) %>% 
    rename(x = Age, year = Year)

hmd_ex_selected_countries


# Code for producing synthetic Germany

source(here("R", "make_synthetic_germany_functions.R"))

series_east_f0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_f0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_f0 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 0,
  sex = "female", 
  ex = make_synthetic_population(series_east_f0, series_west_f0, p_east = 0.2)
)

###
series_east_f65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_f65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_f65 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 65,
  sex = "female", 
  ex = make_synthetic_population(series_east_f65, series_west_f65, p_east = 0.2)
)
##

series_east_m0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_m0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_m0 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 0,
  sex = "male", 
  ex = make_synthetic_population(series_east_m0, series_west_m0, p_east = 0.2)
)


###

series_east_m65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_m65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_m65 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 65,
  sex = "male", 
  ex = make_synthetic_population(series_east_m65, series_west_m65, p_east = 0.2)
)


hmd_ex_selected_countries_with_synth <- bind_rows(
  hmd_ex_selected_countries,
  tmp_df_m0,
  tmp_df_m65,
  tmp_df_f0,
  tmp_df_f65
)

# Labels for codes 

country_code_lookup <- 
  tribble(
    ~code, ~country,
    "DEUTNP", "Germany",
    "DEUTE", "East Germany",
    "DEUTW", "West Germany",
    "ESP", "Spain",
    "FRATNP", "France", 
    "ITA", "Italy",
    "GBRTENW", "England & Wales",
    "GBR_SCO", "Scotland",
    "DEUTSYNTH", "Synthetic Germany"
  )

```

# Results

## Descriptive Results /Starter Eyeballing

### Life expectancy trends 

The following shows life expectancy at birth and at age 65 for selected nations:


Here it is at birth...


```{r, echo = FALSE, fig.cap = "Life Expectancy at birth"}

hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at birth",
    title = "Life expectancies at birth for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )



```


Here it is at age 65

```{r, echo = FALSE, fig.cap = "Life Expectancy at age 65"}
hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at age 65",
    title = "Life expectancies at age 65 for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )

```

Some insightful comment about what's going on.

Scotland looks pretty bad compared with the other countries. 


## Change in life expectancy in these nations 

```{r}
change_in_ex_selected_countries <- 
  hmd_ex_selected_countries_with_synth %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    ungroup() 
    

change_in_ex_selected_countries
```
### Changes in life expectancy at birth 


```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 0) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at birth, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )


```

### Changes in life expectancy at age 65 

```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 65) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at age 65, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )


```


# Discussion


# Time trends 

```{r}

hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    nest() %>% 
    mutate(
      rwd_model = map(data, ~lm(delta_ex ~ 1, data = . )),
      ar_model  = map(data, ~lm(delta_ex ~ lag(delta_ex), data = .))
    ) %>% 
    mutate(
      aic_rwd = map_dbl(rwd_model, AIC),
      aic_ar  = map_dbl(ar_model, AIC)
    ) %>% 
    mutate(
      diff_aic = aic_ar - aic_rwd
    )  %>% 
  # filter(diff_aic > 0)
  mutate(
    tidied_ar_model = map(ar_model, broom::tidy)
  ) %>% 
  unnest(tidied_ar_model) %>% 
  filter(term == "(Intercept)") %>% 
  arrange(desc(estimate)) %>% 
  select(code, x, sex, estimate, std.error) %>% 
  mutate(display_label = glue::glue("{code}_{x}_{sex}")) %>% 
  ggplot(aes(estimate, fct_reorder(display_label, estimate))) + 
  geom_point()


```

Look at improvements by decade

```{r}

hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(decade = year - (year %% 10)) %>% 
    mutate(delta_ex = ex - lag(ex)) %>%
    nest() %>%
    mutate(
      rwd_model = map(data, ~lm(delta_ex ~ factor(decade), data = . ))
     )  %>%
  mutate(
    tidied_rwd_model = map(rwd_model, broom::tidy)
  ) %>%
  unnest(tidied_rwd_model)
```


# Bibliography


