---
title: "How do changes in ex vary between countries?"
author: "Jon Minton, Lucinda Hiam"
date: "22/02/2022"
output:
  html_document: default
  word_document: default
---

# To dos

- [ ] Create flextable by decade

# Introduction 

Stalling of life expectancy improvements occurred in the UK from 2010 onwards. It was also seen in some other Western European countries. While the reason and severity of this is debated, some also contend the stalling of improvements seen is artefact following an unusual decade of improvement in 2000s (e.g. Murphy 2021).

- [ ] Introduction to be written once methods/results discussed and decided on

This notebook will compare annual changes in life expectancy at both birth ($e_0$) and at age 65 ($e_{65}$) from 1980 to 2019 (or the latest available year) in England and Wales, Scotland, France, Italy, Spains and Germany. Germany includes a 'Synthetic Germany' created from a weighted average of East and West German data for common years. The method for creating this 'Synthetic Germany' is covered in the methods section in brief and in Appendix X for more detail. In order to explore the hypothesis that the recent stalling in life expectancy, most marked in England and Wales, was an expected 'correction' after a decade of unusually fast life expectancy improvements, we have selected the years from 1980 onwards.


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  tab.id = NULL,
  tab.cap = NULL,
  tab.topcaption = TRUE,
  tab.lp = "tab:"  
  
  )
```

# Methods 

## Data 

Data were extracted from the [Human Mortality Database](https://mortality.org/) via the R package [`HMDHFDplus`](http://www.demogr.mpg.de/en/projects_publications/publications_1904/mpidr_technical_reports/reading_human_fertility_database_and_human_mortality_database_data_into_r_5438.htm). 

The following countries are included in the comparison:

- England & Wales (`GBRTENW`)
- Scotland (`GBR_SCO`)
- UK as a whole (`GBR_UK`) #we haven't included UK but can do
- France (`FRANTP`)
- Spain (`ESP`)
- Italy (`ITA`)
- Germany
   - Total Germany (`DEUTNP`)
   - East Germany (`DEUTE`)
   - West Germany (`DEUTW`)
   - Simulated/Synthetic Germany


```{r, echo=FALSE}
# load packages

pacman::p_load(knitr, here, tidyverse, flextable) # using flextable instead of gt. It seems to be better 
# developed, more commonly used, and has more clearly labelled function names.

# load data 

hmd_lt <- read_rds(here("data", "lifetables.rds"))

```


## Analysis 

For each of these countries, and for males and females separately, we are interested in the annual changes in life expectancy at birth ($e_0$) and life expectancy at age 65 ($e_{65}$), from 1980 to the last available year for each country. In addition, we compare average life expectancy improvements over the 4 decades: 1980, 1990, 2000, and 2010.

We then compared whether the average between the decades was significant, using a regression model. 

### Synthetic Germany 

- To maybe be moved to the appendix later 

To allow UK national trends to be compared with a single German population, we attempted to produce a 'Synthetic German' population with data for East and West Germany for years prior to reunification. We estimated that this 'Synthetic Germany' could be produced by using a weighted average of 20% East Germany, and 80% West German life expectancy trends. More precise estimates can be produced, and the methods used to reach this conclusion are detailed in Appendix X. 



```{r, echo = FALSE}

countries_of_interest <- c(
  "GBRTENW",
  "GBR_SCO",
  "GBR_UK",
  "FRATNP",
  "ESP",
  "ITA",
  "DEUTNP",
  "DEUTE", 
  "DEUTW"
)

hmd_ex_selected_countries <- 
  hmd_lt %>% 
    filter(code %in% countries_of_interest) %>% 
    filter(Age %in% c(0, 65)) %>% 
    select(code, Year, Age, sex, ex) %>% 
    rename(x = Age, year = Year)

hmd_ex_selected_countries


# Code for producing synthetic Germany

source(here("R", "make_synthetic_germany_functions.R"))

series_east_f0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_f0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_f0 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 0,
  sex = "female", 
  ex = make_synthetic_population(series_east_f0, series_west_f0, p_east = 0.2)
)

###
series_east_f65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_f65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_f65 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 65,
  sex = "female", 
  ex = make_synthetic_population(series_east_f65, series_west_f65, p_east = 0.2)
)
##

series_east_m0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_m0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_m0 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 0,
  sex = "male", 
  ex = make_synthetic_population(series_east_m0, series_west_m0, p_east = 0.2)
)


###

series_east_m65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_m65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_m65 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 65,
  sex = "male", 
  ex = make_synthetic_population(series_east_m65, series_west_m65, p_east = 0.2)
)


hmd_ex_selected_countries_with_synth <- bind_rows(
  hmd_ex_selected_countries,
  tmp_df_m0,
  tmp_df_m65,
  tmp_df_f0,
  tmp_df_f65
)

# Labels for codes 

country_code_lookup <- 
  tribble(
    ~code, ~country,
    "DEUTNP", "Germany",
    "DEUTE", "East Germany",
    "DEUTW", "West Germany",
    "ESP", "Spain",
    "FRATNP", "France", 
    "ITA", "Italy",
    "GBRTENW", "England & Wales",
    "GBR_SCO", "Scotland",
    "DEUTSYNTH", "Synthetic Germany"
  )

```

# Results

## Descriptive Results 

### Life expectancy trends 

The following figures show life expectancy at birth and at age 65 for selected nations from 1980 to the latest available year for males and females.



```{r, echo = FALSE, fig.cap = "Life Expectancy at birth"}

hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at birth",
    title = "Life expectancies at birth for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )



```



```{r, echo = FALSE, fig.cap = "Life Expectancy at age 65"}
hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at age 65",
    title = "Life expectancies at age 65 for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )

```

- [ ] Some insightful comment about what's going on.



## Change in life expectancy in these nations 

Next, we compare the annual change in life expectancy at birth and at aged 65 years for the nations from 1980 to the latest available year, by sex.

```{r, echo=FALSE}
change_in_ex_selected_countries <- 
  hmd_ex_selected_countries_with_synth %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    ungroup() 
    

change_in_ex_selected_countries
```

### Changes in life expectancy at birth 

- [ ] make smoother lines coloured by sex
- [X] use consistent colours for all graphs showing separate sex results


```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 0) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at birth, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )




```

### Changes in life expectancy at age 65 

- [ ] Use slightly stronger (and consistent) colours for sex smoother lines

```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 65) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at age 65, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )


```


## Time trends 

Finally, we used time-trend analysis to explore the changes in life expectancy over the 4 decades: 1980s, 1990s, 2000s, and 2010s. This produces the average change for the decade, whether negative or positive, the standard error and its statistical significance for each country by sex.

- [X] Give this a title and further info (lower priority)
- [X] Look at splitting by starting age 
    - [ ] Look at further refining starting age split

```{r, echo = FALSE, warning = FALSE, message = FALSE}

hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    filter(!(code %in% c("DEUTE", "DEUTW", "DEUTNP"))) %>%  # Using only synthetic germany for longer time period
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    nest() %>% 
    mutate(
      rwd_model = map(data, ~lm(delta_ex ~ 1, data = . )),
      ar_model  = map(data, ~lm(delta_ex ~ lag(delta_ex), data = .))
    ) %>% 
    mutate(
      aic_rwd = map_dbl(rwd_model, AIC),
      aic_ar  = map_dbl(ar_model, AIC)
    ) %>% 
    mutate(
      diff_aic = aic_ar - aic_rwd
    )  %>% 
  # filter(diff_aic > 0)
  mutate(
    tidied_ar_model = map(ar_model, broom::tidy)
  ) %>% 
  unnest(tidied_ar_model) %>% 
  filter(term == "(Intercept)") %>% 
  arrange(desc(estimate)) %>%
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  select(code, country, x, sex, estimate, std.error) %>% 
  mutate(display_label = glue::glue("{country}_{x}_{sex}")) %>% 
  ggplot(aes(estimate, fct_reorder(display_label, estimate))) + 
  geom_point() +
  expand_limits( x = 0) + 
  geom_vline(xintercept = 0) + 
  labs(
    x = "Average annual life expectancy change",
    y = "Country-sex combination",
    title = "Average annual improvements by country and sex",
    subtitle = "Range: 1980 to 2020 or nearest available years",
    caption = "Source: Human Mortality Database"
  ) + 
  facet_wrap(~x)
  


```

### Average improvements by decade

- [ ] Add further introduction 
- [ ] Add statistical significance (though maybe this is a different analysis)

The table below shows average improvements by decade for England and Wales (standard error).

```{r, echo=FALSE, tab.cap = "Source: HMD"}

hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>%
    mutate(decade = year - (year %% 10)) %>% 
    filter(!is.na(delta_ex)) %>% 
  group_by(code, x, sex, decade) %>% 
  summarise(
    mean_delta_ex = mean(delta_ex),
    sd_delta_ex   = sd(delta_ex)
    ) %>% 
  ungroup() %>% 
  mutate(cell_contents = glue::glue("{round(mean_delta_ex, 3)} ({round(sd_delta_ex, 3)})")
  ) %>% 
  filter(code == "GBRTENW") %>% 
  filter(x == 0) %>% 
  select(sex, decade, cell_contents) %>% 
  spread(decade, cell_contents) %>% 
#  write.csv("clipboard")
  flextable() %>%
  # Want to make the header row bold
  vline(j = 1, part = "all") %>%
  set_caption(caption = "Average improvement in life expectancy by decade") 
  



```

### Are the differences by decade statistically significant? 

Are there significant differences in average rates of change in $e_x$ by decade? Another way of expressing this question is to ask whether knowing the decade in which an observation has been observed is informative as to what such values will be. This rephrased question was addressed by, for each starting age (0 or 65 years), sex and country, fitting two competing model specifications - $M_0$ and $M_A$ - and running an F test on the residuals of these two models. The Null model specification, $M_0$, regresses $\delta e_x$ (observed annual changes in $e_x$) against a single intercept term $\alpha$; put another way: $M_0$ assumes that all observations are drawn from a Normal distribution with a mean value of $\alpha$, and that this is consistent across all observed decades. The alternative model specification, $M_A$, also includes the $\alpha$ term, but also includes dummy variables to indicate which decade the realised value of $\delta e_0$ corresponds to. (Because one of the decades needs to be the reference category against which other decades are compared, there are one fewer decadal dummy variables than decades in the dataset for a given country, and the $\alpha$ parameter in $M_A$ estimates the mean change in $\delta e_0$ in the first decade, and so cannot be compared directly with the $\alpha$ parameter in $M_0$.) A P-value from the F test comparing $M_0$ and $M_A$ of less than 0.05 is taken to indicate that $M_A$ should be preferred to $M_0$, and so that there are systemic differences in average rates of improvement by decade for a given country, sex, and starting age. 


We found the only significant change decade-on-decades was for East Germany for females at birth and at aged 65 years. This is consistent with existing literature in this area, showing the convergence of life expectancy for females in East and West Germany following reunification.


```{r, cache=TRUE}


dta_for_decade_comparison <- 
  hmd_ex_selected_countries_with_synth %>% 
      filter(x == 0) %>% 
      filter(sex == "female") %>% 
      filter(code == "GBRTENW") %>% 
      filter(year >= 1979) %>% 
      # ggplot(aes(x = year, y = ex)) +
      #   geom_line()
      arrange(year) %>% 
      mutate(delta_ex = ex - lag(ex)) %>% 
    #   ggplot(aes(x = year, y = delta_ex)) + 
    # geom_point() + geom_line() +
    # geom_hline(yintercept = 0)
      mutate(
        decade = year - (year %% 10)
      ) %>% 
  filter(!is.na(delta_ex))

model_null <- 
  lm(delta_ex ~ 1, data = dta_for_decade_comparison)

model_alt <- 
  lm(delta_ex ~ factor(decade), data= dta_for_decade_comparison)

summary(model_null)

summary(model_alt)

anova(model_null, model_alt)

# to get the value of interest do tmp[2,6]


# Generalising 

tidy_dataset <- function(df){
  df %>% 
      filter(year >= 1979) %>% 
      arrange(year) %>% 
      mutate(delta_ex = ex - lag(ex)) %>% 
      mutate(
        decade = year - (year %% 10)
      ) %>% 
  filter(!is.na(delta_ex))
}

make_null_model <- function(df){
  lm(delta_ex ~ 1, data = df)
}

all_null_alt_models <-
  hmd_ex_selected_countries_with_synth %>%
    group_by(x, sex, code) %>% 
    nest() %>% 
    mutate(
      prep_data = map(data, tidy_dataset) 
    ) %>% 
    mutate(
      model_null = map(prep_data, ~lm(delta_ex ~ 1, data = .)),
      model_alt  = map(prep_data, ~lm(delta_ex ~ factor(decade), data = .))
  #    model_null = map(prep_data, make_null_model)
    ) %>% 
    mutate(
      anova_results = map2(model_null, model_alt, anova)
    ) %>% 
    mutate(
      anova_pval = map_dbl(anova_results, ~.[2,6])
    ) 

all_null_alt_models %>% 
  filter(anova_pval < 0.05) -> tmp

summary(tmp$model_alt[[1]])

summary(tmp$model_alt[[2]])

  # build null model
  # build alt model
  # do anova
  # get p value from anova
  
  

  
```

### Joinpoint/Segmented regression approach 

Though there may be systemic differences in average changes in life expectancy over time, such differences may not be patterned by decade, and so the above model specification may not have been appropriate to detect any such changes. Instead of looking for systemic differences by decade, we can instead look at whether there are any systemic and detectable 'breaks' in the trends over time. If our data were life expectancy over time, this could be achieved through joinpoint analysis, in which the slope is allowed to change over time. As instead are data are annual changes in life expectancy, we are interested in detecting changes in intercept over time. If we define our Null (no change) model as follows: 

$$
M_0 : y(t) = \alpha + e
$$
Where $e \backsim N(0, \sigma^2)$. i.e. all observations $y$ are draws from $N(\alpha, \sigma^2)$. The alternative model specification against which this is compared is then: 

$$
M_A : y(t) = \alpha_0 + \beta_1 T(t) + e 
$$
Where $T(t)$ is defined as $0$ where $t \lt \tau$ and $1$ where $t \geq \tau$. ($\alpha_0$ is used in $M_A$ to indicate that this parameter is not directly comparable with $\alpha$ in $M_0$).

This specification shows that there is an additional parameter $\tau$ to be determined in order to produce $M_A$. This $\tau$ parameter is the breakpoint in the series. The selection of $\tau$ will be determined by numeric optimisation, by selecting the value of $\tau$ that minimised AIC. 

Once the best possible $M_A$, using the best value of $\tau$, is selected, $M_A$ will be compared with $M_0$ using an F-test, allowing us to determine whether there is convincing evidence of any specific break in the data.  

We will start with a single country, starting age, and sex, and with manual selection of $\tau$, then generalise and automate further. 


```{r}

# Let's start with a single example population. (There are many different population subgroups, hence the 
# benefit of being able to automate this later.) We're going to start with England & Wales, females, life 
# expectancy at birth (x == 0)

example_df <- 
  hmd_ex_selected_countries_with_synth %>% 
      filter(x == 0) %>% 
      filter(sex == "female") %>% 
      filter(code == "GBRTENW") %>% 
      filter(year >= 1979)

# Now we create the change in ex variable as that's the response variable in the model
example_df <- 
  example_df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) # %>% 
  # ggplot(aes(x = year, y = delta_ex)) + geom_point() + 
  # geom_line() +
  # geom_hline(yintercept = 0) + 
  # stat_smooth()

# The null model is really simple: just an intercept 
model_null <- lm(delta_ex ~ 1, data = example_df)
summary(model_null)
# 

# The code below shows how we can be even simpler, and force the regression model not to 
# even have an intercept (i.e. have zero predictor variables)

# model_nuller <- lm(delta_ex ~ 0, data = example_df)
# summary(model_nuller)

# And we can compare the intercept with the no intercept model as follows 
# anova(model_nuller, model_null)
# a statistically significant p value shows the intercept is definitely worth including in the 
# model. Substantively that it's wrong to assume no improvement on average in ex over time since the 1980s


# There are lots of possible alternative models, some examples of which are below:
model_alt01 <- lm(delta_ex ~ year >= 1990, data = example_df)
summary(model_alt01)

model_alt02 <- lm(delta_ex ~ year >= 1995, data = example_df)
summary(model_alt02)

model_alt03 <- lm(delta_ex ~ year >= 1997, data = example_df)
summary(model_alt03)

model_alt04 <- lm(delta_ex ~ year >= 2008, data = example_df)
summary(model_alt04)

model_alt05 <- lm(delta_ex ~ year >= 2011, data = example_df)
summary(model_alt05)

# each of these models allows an adjustment to the horizontal line after a given year has been reached. 
# In the examples above some possible given years are 1990, 1995, 1997, 2008 and 2011. 
# Each of these is a candidate value for tau. But we've not looked at all possible/plausible values of this. 

# Hence, it would be good to automate further to search for each possible tau and see how the fit and model 
# results change. 

# We'll start to automate by building a function which creates T_param given tau, and runs and returns the model
# with this type of T_param
# (If tau is 1990, then T_param is equivalent to model_alt01 above; if tau were 1995, then it's equivalent to model_alt02, and so on. The only difference is that the new coefficient created has the same name, T_param, 
# whereas in the above it would have a different name each time, because the coefficient is being 
# created in situ, within the formula specification, rather than by pre-processing the dataframe)
run_alt_with_given_tau <- function(tau, df){
  df <- 
    df %>% 
      filter(!is.na(delta_ex)) %>% 
      mutate(
        T_param = ifelse(year < tau, FALSE, TRUE)
      )
  
  lm(delta_ex ~ T_param, data  = df)
}

# We can now run the above function, which creates a model, for a wide range of possible tau values
# This is the sequence listed and named tau_candidate, which is every whole number from 
# 1982 to 2015

# For each of these models, we can then get a measure of model fit. We're going to use AIC, though 
# could have used other measures. With AIC (and with BIC, and RMSE etc) better fit is indicated with 
# a lower value
grid_search_df <- tibble(
  tau_candidate = 1982:2015 # column of candidate values
) %>% 
  mutate(
    model_alt = map(tau_candidate, run_alt_with_given_tau, df = example_df) # run the model with the value of tau in tau_candidate
  ) %>% 
  mutate(
    aic = map_dbl(model_alt, AIC)
  )


# Now we can see which proposed tau results in what fit value (AIC), initially just by graphing it.
grid_search_df %>% 
  ggplot(aes(tau_candidate, aic)) + 
  geom_point()

# So, in the above we found 2012 as tau minimised AIC. So, that's the best possible alternative model. 
# Let's run and label it as such
best_alt_model <- example_df %>% 
  mutate( T_param = ifelse(year < 2012, FALSE, TRUE)) %>% 
  lm(delta_ex ~ T_param, data = .)

# Now we want to create the null model to compare it against (which just has an intercept term alone)
null_model <- example_df %>% 
  lm(delta_ex ~ 1, data = .)

# And finally, we want to compare the best_alt_model against the null model using an F test
anova(null_model, best_alt_model)
# We are interested in the P value here. If it's statistically significant then the best_alt_model does better
# (Is worth its additional complexity in terms of how much it makes the model fit) than the null model,
# So... for females, from birth, in England & Wales, there's evidence that there WAS a significant change in 
# average life expectancy improvement from 2012 onwards. (i.e. two years after austerity was introduced)


# We can manually repeat the same exercise for some additional subsets of the data (population, gender, starting age combinations). The below shows the same for males in England & Wales, from birth.


example_df <- 
  hmd_ex_selected_countries_with_synth %>% 
      filter(x == 0) %>% 
      filter(sex == "male") %>% 
      filter(code == "GBRTENW") %>% 
      filter(year >= 1979)

example_df <- 
  example_df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex))

grid_search_df <- tibble(
  tau_candidate = 1982:2015
) %>% 
  mutate(
    model_alt = map(tau_candidate, run_alt_with_given_tau, df = example_df)
  ) %>% 
  mutate(
    aic = map_dbl(model_alt, AIC)
  )

grid_search_df %>% 
  ggplot(aes(tau_candidate, aic)) + 
  geom_point()


best_alt_model <- example_df %>% 
  mutate( T_param = ifelse(year < 2013, FALSE, TRUE)) %>% 
  lm(delta_ex ~ T_param, data = .)

null_model <- example_df %>% 
  lm(delta_ex ~ 1, data = .)

anova(null_model, best_alt_model)

# This time 2013 is a slightly better candidate than 2012, hence 2013 being used in best_alt_model not 2012. 


# Another example: France, males
###
example_df <- 
  hmd_ex_selected_countries_with_synth %>% 
      filter(x == 0) %>% 
      filter(sex == "male") %>% 
      filter(code == "FRATNP") %>% 
      filter(year >= 1979)

example_df <- 
  example_df %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex))

grid_search_df <- tibble(
  tau_candidate = 1982:2015
) %>% 
  mutate(
    model_alt = map(tau_candidate, run_alt_with_given_tau, df = example_df)
  ) %>% 
  mutate(
    aic = map_dbl(model_alt, AIC)
  )

grid_search_df %>% 
  ggplot(aes(tau_candidate, aic)) + 
  geom_point()


best_alt_model <- example_df %>% 
  mutate( T_param = ifelse(year < 2012, FALSE, TRUE)) %>% 
  lm(delta_ex ~ T_param, data = .)


summary(best_alt_model)

null_model <- example_df %>% 
  lm(delta_ex ~ 1, data = .)
summary(null_model)


anova(null_model, best_alt_model)

# Here 2015 has the lowest value, but this might be an artefact of the data period covered. 
# We can also see that 2012 is the next best candidate.
```


# Discussion

- **Limitations**: fewer years for comparison in 2010s for some nations; comparing different time periods will provide different results e.g. New Labour years in E&W.

# Appendix A: Construction of Synthetic Germany 

- Add further details here. 

# Bibliography


