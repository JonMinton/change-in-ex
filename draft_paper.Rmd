---
title: "How do changes in ex vary between countries?"
author: "Jon Minton"
date: "22/02/2022"
output:
  html_document: default
  word_document: default
---

# To dos

- [ ] Create flextable by decade

# Introduction 

Stalling of life expectancy improvements occurred in the UK from 2010 onwards. It was also seen in some other Western European countries. While the reason and severity of this is debated, some also contend the stalling of improvements seen is artefact following an unusual decade of improvement in 2000s (Murphy 2021).

- [ ] Introduction to be written once methods/results discussed and decided on

This notebook will compare annual changes in life expectancy at both birth ($e_0$) and at age 65 ($e_{65}$) from 1980 to 2019 (or the latest available year) in England and Wales, Scotland, France, Italy, Spains and Germany. Germany includes a 'Synthetic Germany' created from a weighted average of East and West German data for common years. The method for creating this 'Synthetic Germany' is covered in the methods section in brief and in Appendix X for more detail. In order to explore the hypothesis that the recent stalling in life expectancy, most marked in England and Wales, was an expected 'correction' after a decade of unusually fast life expectancy improvements, we have selected the years from 1980 onwards.


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  tab.id = NULL,
  tab.cap = NULL,
  tab.topcaption = TRUE,
  tab.lp = "tab:"  
  
  )
```

# Methods 

## Data 

Data were extracted from the [Human Mortality Database](https://mortality.org/) via the R package [`HMDHFDplus`](http://www.demogr.mpg.de/en/projects_publications/publications_1904/mpidr_technical_reports/reading_human_fertility_database_and_human_mortality_database_data_into_r_5438.htm). 

The following countries are included in the comparison:

- England & Wales (`GBRTENW`)
- Scotland (`GBR_SCO`)
- UK as a whole (`GBR_UK`) #we haven't included UK but can do
- France (`FRANTP`)
- Spain (`ESP`)
- Italy (`ITA`)
- Germany
   - Total Germany (`DEUTNP`)
   - East Germany (`DEUTE`)
   - West Germany (`DEUTW`)
   - Simulated/Synthetic Germany


```{r, echo=FALSE}
# load packages

pacman::p_load(knitr, here, tidyverse, flextable) # using flextable instead of gt. It seems to be better 
# developed, more commonly used, and has more clearly labelled function names.

# load data 

hmd_lt <- read_rds(here("data", "lifetables.rds"))

```


## Analysis 

For each of these countries, and for males and females separately, we are interested in the annual changes in life expectancy at birth ($e_0$) and life expectancy at age 65 ($e_{65}$), from 1980 to the last available year for each country. In addition, we compare average life expectancy improvements over the 4 decades: 1980, 1990, 2000, and 2010.

We then compared whether the average between the decades was significant, using a regression model. 

### Synthetic Germany 

- To maybe be moved to the appendix later 

To allow UK national trends to be compared with a single German population, we attempted to produce a 'Synthetic German' population with data for East and West Germany for years prior to reunification. We estimated that this 'Synthetic Germany' could be produced by using a weighted average of 20% East Germany, and 80% West German life expectancy trends. More precise estimates can be produced, and the methods used to reach this conclusion are detailed in Appendix X. 



```{r, echo = FALSE}

countries_of_interest <- c(
  "GBRTENW",
  "GBR_SCO",
  "GBR_UK",
  "FRATNP",
  "ESP",
  "ITA",
  "DEUTNP",
  "DEUTE", 
  "DEUTW"
)

hmd_ex_selected_countries <- 
  hmd_lt %>% 
    filter(code %in% countries_of_interest) %>% 
    filter(Age %in% c(0, 65)) %>% 
    select(code, Year, Age, sex, ex) %>% 
    rename(x = Age, year = Year)

hmd_ex_selected_countries


# Code for producing synthetic Germany

source(here("R", "make_synthetic_germany_functions.R"))

series_east_f0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_f0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_f0 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 0,
  sex = "female", 
  ex = make_synthetic_population(series_east_f0, series_west_f0, p_east = 0.2)
)

###
series_east_f65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_f65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "female") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_f65 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 65,
  sex = "female", 
  ex = make_synthetic_population(series_east_f65, series_west_f65, p_east = 0.2)
)
##

series_east_m0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_m0 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_m0 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 0,
  sex = "male", 
  ex = make_synthetic_population(series_east_m0, series_west_m0, p_east = 0.2)
)


###

series_east_m65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTE") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)

series_west_m65 <- hmd_ex_selected_countries %>% 
  filter(code == "DEUTW") %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  filter(sex == "male") %>% 
  arrange(year) %>% 
  pull(ex)


tmp_df_m65 <- tibble(
  code = "DEUTSYNTH",
  year = 1980:2017,
  x = 65,
  sex = "male", 
  ex = make_synthetic_population(series_east_m65, series_west_m65, p_east = 0.2)
)


hmd_ex_selected_countries_with_synth <- bind_rows(
  hmd_ex_selected_countries,
  tmp_df_m0,
  tmp_df_m65,
  tmp_df_f0,
  tmp_df_f65
)

# Labels for codes 

country_code_lookup <- 
  tribble(
    ~code, ~country,
    "DEUTNP", "Germany",
    "DEUTE", "East Germany",
    "DEUTW", "West Germany",
    "ESP", "Spain",
    "FRATNP", "France", 
    "ITA", "Italy",
    "GBRTENW", "England & Wales",
    "GBR_SCO", "Scotland",
    "DEUTSYNTH", "Synthetic Germany"
  )

```

# Results

## Descriptive Results 

### Life expectancy trends 

The following figures show life expectancy at birth and at age 65 for selected nations from 1980 to the latest available year for males and females.



```{r, echo = FALSE, fig.cap = "Life Expectancy at birth"}

hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 0) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at birth",
    title = "Life expectancies at birth for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )



```



```{r, echo = FALSE, fig.cap = "Life Expectancy at age 65"}
hmd_ex_selected_countries_with_synth %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  filter(x == 65) %>% 
  ggplot(aes(x = year, y = ex, group = sex, colour = sex, linetype = sex)) + 
  geom_line() +
  facet_wrap(~country) +
  labs(
    x = "Year",
    y = "Life Expectancy at age 65",
    title = "Life expectancies at age 65 for selected nations",
    subtitle = "1980 to 2020 or latest available year",
    caption = "Source: Human Mortality Database"
  )

```

- [ ] Some insightful comment about what's going on.



## Change in life expectancy in these nations 

Next, we compare the annual change in life expectancy at birth and at aged 65 years for the nations from 1980 to the latest available year, by sex.

```{r}
change_in_ex_selected_countries <- 
  hmd_ex_selected_countries_with_synth %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    ungroup() 
    

change_in_ex_selected_countries
```

### Changes in life expectancy at birth 

- [ ] make smoother lines coloured by sex
- [X] use consistent colours for all graphs showing separate sex results


```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 0) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at birth, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )




```

### Changes in life expectancy at age 65 

- [ ] Use slightly stronger (and consistent) colours for sex smoother lines

```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height=8, fig.width=8}
change_in_ex_selected_countries %>% 
  filter(x == 65) %>% 
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  filter(between(year, 1980, 2020)) %>% 
  ggplot(aes(x = year, y = delta_ex, colour=sex)) + 
  geom_point(alpha = 0.2) + 
  stat_smooth() + 
  facet_grid(country~sex) + 
  geom_hline(yintercept = 0) + 
  theme(strip.text.y = element_text(angle = 0)) + 
  labs(
    x = "Year",
    y = "Year-on-year change in life expectancy",
    title = "Annual change in life expectancy at age 65, selected countries",
    subtitle = "Blue line: nonlinear smoother",
    caption =  "Source: Human Mortality Database. Synthetic Germany based on 20% East/80% West German population weighting"
  )


```


## Time trends 

Finally, we used time-trend analysis to explore the changes in life expectancy over the 4 decades: 1980s, 1990s, 2000s, and 2010s. This produces the average change for the decade, whether negative or positive, the standard error and its statistical significance for each country by sex.

- [X] Give this a title and further info (lower priority)
- [X] Look at splitting by starting age 
    - [ ] Look at further refining starting age split

```{r, echo = FALSE, warning = FALSE, message = FALSE}

hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    filter(!(code %in% c("DEUTE", "DEUTW", "DEUTNP"))) %>%  # Using only synthetic germany for longer time period
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>% 
    nest() %>% 
    mutate(
      rwd_model = map(data, ~lm(delta_ex ~ 1, data = . )),
      ar_model  = map(data, ~lm(delta_ex ~ lag(delta_ex), data = .))
    ) %>% 
    mutate(
      aic_rwd = map_dbl(rwd_model, AIC),
      aic_ar  = map_dbl(ar_model, AIC)
    ) %>% 
    mutate(
      diff_aic = aic_ar - aic_rwd
    )  %>% 
  # filter(diff_aic > 0)
  mutate(
    tidied_ar_model = map(ar_model, broom::tidy)
  ) %>% 
  unnest(tidied_ar_model) %>% 
  filter(term == "(Intercept)") %>% 
  arrange(desc(estimate)) %>%
  left_join(country_code_lookup) %>% 
  mutate(country = factor(country, levels = c("England & Wales", "Scotland", "East Germany", "West Germany", "Germany", "Synthetic Germany", "Spain", "France", "Italy"))) %>% 
  select(code, country, x, sex, estimate, std.error) %>% 
  mutate(display_label = glue::glue("{country}_{x}_{sex}")) %>% 
  ggplot(aes(estimate, fct_reorder(display_label, estimate))) + 
  geom_point() +
  expand_limits( x = 0) + 
  geom_vline(xintercept = 0) + 
  labs(
    x = "Average annual life expectancy change",
    y = "Country-sex combination",
    title = "Average annual improvements by country and sex",
    subtitle = "Range: 1980 to 2020 or nearest available years",
    caption = "Source: Human Mortality Database"
  ) + 
  facet_wrap(~x)
  


```

### Average improvements by decade

- [ ] Add further introduction 
- [ ] Add statistical significance (though maybe this is a different analysis)

```{r, tab.cap = "Source: HMD"}

hmd_ex_selected_countries_with_synth %>% 
    filter(year >= 1979) %>% 
    group_by(code, x, sex) %>% 
    arrange(year) %>% 
    mutate(delta_ex = ex - lag(ex)) %>%
    mutate(decade = year - (year %% 10)) %>% 
    filter(!is.na(delta_ex)) %>% 
  group_by(code, x, sex, decade) %>% 
  summarise(
    mean_delta_ex = mean(delta_ex),
    sd_delta_ex   = sd(delta_ex)
    ) %>% 
  ungroup() %>% 
  mutate(cell_contents = glue::glue("{round(mean_delta_ex, 3)} ({round(sd_delta_ex, 3)})")
  ) %>% 
  filter(code == "GBRTENW") %>% 
  filter(x == 0) %>% 
  select(sex, decade, cell_contents) %>% 
  spread(decade, cell_contents) %>% 
#  write.csv("clipboard")
  flextable() %>%
  # Want to make the header row bold
  vline(j = 1, part = "all") %>%
  set_caption(caption = "Average improvement in life expectancy by decade") 
  



```

###Are the differences by decade statistically significant? 
To assess whether the changes by decade are statistically significant, we carried out [Jon please could you write a little more here?]
We found the only significant change decade-on-decades was for East Germany for females at birth and at aged 65 years...


```{r}


dta_for_decade_comparison <- 
  hmd_ex_selected_countries_with_synth %>% 
      filter(x == 0) %>% 
      filter(sex == "female") %>% 
      filter(code == "GBRTENW") %>% 
      filter(year >= 1979) %>% 
      # ggplot(aes(x = year, y = ex)) +
      #   geom_line()
      arrange(year) %>% 
      mutate(delta_ex = ex - lag(ex)) %>% 
    #   ggplot(aes(x = year, y = delta_ex)) + 
    # geom_point() + geom_line() +
    # geom_hline(yintercept = 0)
      mutate(
        decade = year - (year %% 10)
      ) %>% 
  filter(!is.na(delta_ex))

model_null <- 
  lm(delta_ex ~ 1, data = dta_for_decade_comparison)

model_alt <- 
  lm(delta_ex ~ factor(decade), data= dta_for_decade_comparison)

summary(model_null)

summary(model_alt)

anova(model_null, model_alt)

# to get the value of interest do tmp[2,6]


# Generalising 

tidy_dataset <- function(df){
  df %>% 
      filter(year >= 1979) %>% 
      arrange(year) %>% 
      mutate(delta_ex = ex - lag(ex)) %>% 
      mutate(
        decade = year - (year %% 10)
      ) %>% 
  filter(!is.na(delta_ex))
}

make_null_model <- function(df){
  lm(delta_ex ~ 1, data = df)
}

all_null_alt_models <-
  hmd_ex_selected_countries_with_synth %>%
    group_by(x, sex, code) %>% 
    nest() %>% 
    mutate(
      prep_data = map(data, tidy_dataset) 
    ) %>% 
    mutate(
      model_null = map(prep_data, ~lm(delta_ex ~ 1, data = .)),
      model_alt  = map(prep_data, ~lm(delta_ex ~ factor(decade), data = .))
  #    model_null = map(prep_data, make_null_model)
    ) %>% 
    mutate(
      anova_results = map2(model_null, model_alt, anova)
    ) %>% 
    mutate(
      anova_pval = map_dbl(anova_results, ~.[2,6])
    ) 

all_null_alt_models %>% 
  filter(anova_pval < 0.05) -> tmp

summary(tmp$model_alt[[1]])

summary(tmp$model_alt[[2]])

  # build null model
  # build alt model
  # do anova
  # get p value from anova
  
  

  
```



# Discussion

- **Limitations**: fewer years for comparison in 2010s; comparing different time periods will provide different results.
- Add description of what this needs 

# Appendix A: Construction of Synthetic Germany 

- Add further details here. 

# Bibliography


